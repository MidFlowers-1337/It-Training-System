# IT 技能培训智能选课系统 - 业务规则文档

> 文档版本：v1.0.0
> 最后更新：2025-12-14
> 文档状态：✅ 已完成

---

## 目录

1. [实体与字段字典](#1-实体与字段字典)
2. [报名状态机](#2-报名状态机)
3. [名额控制策略](#3-名额控制策略)
4. [业务规则清单](#4-业务规则清单)
5. [边界与不做项](#5-边界与不做项)
6. [术语统一表](#6-术语统一表)
7. [与 easy-enroll 业务术语映射](#7-与-easy-enroll-业务术语映射)

---

## 1. 实体与字段字典

### 1.1 用户（User）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | BIGINT | Y | 主键，自增 |
| username | VARCHAR(50) | Y | 登录用户名，唯一 |
| password | VARCHAR(255) | Y | 密码（BCrypt加密） |
| real_name | VARCHAR(50) | Y | 真实姓名 |
| phone | VARCHAR(20) | N | 手机号 |
| email | VARCHAR(100) | N | 邮箱 |
| avatar | VARCHAR(255) | N | 头像URL |
| role | VARCHAR(20) | Y | 角色：ADMIN/INSTRUCTOR/STUDENT |
| status | TINYINT | Y | 状态：0-禁用 1-启用 |
| created_at | DATETIME | Y | 创建时间 |
| updated_at | DATETIME | Y | 更新时间 |
| deleted | TINYINT | Y | 软删除：0-正常 1-已删除 |

**业务规则：**
- BR-U01：username 全局唯一，注册后不可修改
- BR-U02：密码最少 6 位，存储前必须 BCrypt 加密
- BR-U03：同一手机号/邮箱可被多个用户使用（不作为登录凭证）
- BR-U04：删除用户为软删除，不影响历史报名记录

---

### 1.2 课程（Course）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | BIGINT | Y | 主键，自增 |
| code | VARCHAR(30) | Y | 课程编码，唯一（如：JAVA-001） |
| name | VARCHAR(100) | Y | 课程名称 |
| category | VARCHAR(50) | Y | 分类：后端开发/前端开发/数据库/云计算/AI/其他 |
| description | TEXT | N | 课程简介 |
| cover_image | VARCHAR(255) | N | 封面图URL |
| difficulty | TINYINT | Y | 难度：1-入门 2-初级 3-中级 4-高级 |
| duration_hours | INT | Y | 课时数（小时） |
| prerequisites | VARCHAR(500) | N | 先修要求（课程编码，逗号分隔） |
| tags | VARCHAR(200) | N | 标签（逗号分隔，如：Java,Spring,微服务） |
| status | TINYINT | Y | 状态：0-下架 1-上架 |
| created_at | DATETIME | Y | 创建时间 |
| updated_at | DATETIME | Y | 更新时间 |
| deleted | TINYINT | Y | 软删除 |

**业务规则：**
- BR-C01：课程编码全局唯一，创建后不可修改
- BR-C02：仅上架状态的课程对学员可见
- BR-C03：有关联班期的课程不能删除，只能下架
- BR-C04：difficulty 用于 AI 推荐排序

---

### 1.3 班期（ClassSession）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | BIGINT | Y | 主键，自增 |
| course_id | BIGINT | Y | 所属课程ID |
| instructor_id | BIGINT | Y | 授课讲师ID |
| session_code | VARCHAR(30) | Y | 班期编码（如：JAVA-001-2024S1） |
| start_date | DATE | Y | 开班日期 |
| end_date | DATE | Y | 结束日期 |
| schedule | VARCHAR(200) | N | 上课时间描述（如：每周六 9:00-12:00） |
| location | VARCHAR(200) | N | 上课地点/线上链接 |
| max_capacity | INT | Y | 最大名额 |
| current_enrollment | INT | Y | 当前报名人数（冗余字段，便于查询） |
| status | TINYINT | Y | 状态：0-未开放 1-报名中 2-已满员 3-进行中 4-已结束 |
| created_at | DATETIME | Y | 创建时间 |
| updated_at | DATETIME | Y | 更新时间 |
| deleted | TINYINT | Y | 软删除 |

**业务规则：**
- BR-S01：session_code 全局唯一
- BR-S02：start_date 必须 > 当前日期（创建时）
- BR-S03：end_date 必须 >= start_date
- BR-S04：current_enrollment <= max_capacity
- BR-S05：只有 status=1（报名中）的班期允许报名
- BR-S06：当 current_enrollment = max_capacity 时，status 自动变为 2（已满员）
- BR-S07：有报名记录的班期不能删除

---

### 1.4 报名记录（Enrollment）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | BIGINT | Y | 主键，自增 |
| user_id | BIGINT | Y | 学员ID |
| session_id | BIGINT | Y | 班期ID |
| status | TINYINT | Y | 状态：0-已报名 1-已取消 |
| enrolled_at | DATETIME | Y | 报名时间 |
| canceled_at | DATETIME | N | 取消时间 |
| cancel_reason | VARCHAR(200) | N | 取消原因 |
| created_at | DATETIME | Y | 创建时间 |
| updated_at | DATETIME | Y | 更新时间 |

**业务规则：**
- BR-E01：同一学员对同一班期只能有一条有效报名（status=0）
- BR-E02：已取消的报名可以重新报名（创建新记录）
- BR-E03：报名记录不做物理删除
- BR-E04：取消报名时必须回退班期名额

---

### 1.5 AI 推荐日志（AiRecommendLog）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | BIGINT | Y | 主键，自增 |
| user_id | BIGINT | Y | 请求用户ID |
| input_text | TEXT | Y | 用户输入的学习目标 |
| recommended_courses | TEXT | Y | 推荐结果JSON |
| reason | TEXT | Y | 推荐理由 |
| model_used | VARCHAR(50) | Y | 使用的AI模型 |
| response_time_ms | INT | Y | 响应耗时(毫秒) |
| created_at | DATETIME | Y | 创建时间 |

**业务规则：**
- BR-A01：每次 AI 推荐请求必须记录日志
- BR-A02：推荐结果包含课程ID列表和学习顺序
- BR-A03：AI 服务不可用时返回热门课程作为降级

---

## 2. 报名状态机

### 2.1 状态定义

| 状态值 | 状态名 | 说明 |
|--------|--------|------|
| 0 | ENROLLED（已报名） | 报名成功，占用名额 |
| 1 | CANCELED（已取消） | 学员主动取消，释放名额 |

### 2.2 状态流转图

```
┌─────────────────────────────────────────────────────────┐
│                      报名状态机                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    ┌──────────┐                                        │
│    │  (初始)   │                                        │
│    └────┬─────┘                                        │
│         │ 学员提交报名                                   │
│         │ [前置条件：班期报名中 AND 有名额 AND 未重复报名]  │
│         ▼                                              │
│    ┌──────────┐                                        │
│    │  已报名   │ ◄─────────────────────┐               │
│    │ ENROLLED │                        │               │
│    └────┬─────┘                        │               │
│         │                              │               │
│         │ 学员取消报名                  │ 重新报名       │
│         │ [action: 名额+1]             │ (创建新记录)    │
│         ▼                              │               │
│    ┌──────────┐                        │               │
│    │  已取消   │ ──────────────────────┘               │
│    │ CANCELED │                                        │
│    └──────────┘                                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.3 状态流转规则

| 当前状态 | 目标状态 | 触发动作 | 前置条件 | 后置动作 |
|----------|----------|----------|----------|----------|
| - | ENROLLED | 提交报名 | ① 班期 status=1 ② current < max ③ 无有效报名 | current_enrollment + 1 |
| ENROLLED | CANCELED | 取消报名 | 班期未结束 | current_enrollment - 1 |
| CANCELED | ENROLLED | 重新报名 | 同"提交报名" | 创建新报名记录 |

### 2.4 非法流转（必须拒绝）

| 场景 | 拒绝原因 | 错误码 |
|------|----------|--------|
| 班期已满员时报名 | 名额不足 | E4001 |
| 已有有效报名再次报名 | 重复报名 | E4002 |
| 班期非"报名中"状态时报名 | 班期不可报名 | E4003 |
| 已取消的报名再次取消 | 状态不允许 | E4004 |
| 班期已结束后取消 | 班期已结束 | E4005 |

---

## 3. 名额控制策略

### 3.1 MVP 方案：数据库事务 + 条件更新

```sql
-- 报名时原子性扣减名额
UPDATE class_session
SET current_enrollment = current_enrollment + 1,
    status = CASE WHEN current_enrollment + 1 >= max_capacity THEN 2 ELSE status END
WHERE id = #{sessionId}
  AND current_enrollment < max_capacity
  AND status = 1;

-- 检查影响行数：
-- = 1：扣减成功，继续创建报名记录
-- = 0：名额不足或状态不允许，抛出业务异常
```

**优点：**
- 实现简单，无额外依赖
- 利用数据库行锁保证一致性

**缺点：**
- 高并发下数据库压力大
- 存在锁等待

### 3.2 增强方案：Redis 预扣减（文档记录，不强制实现）

```
┌─────────────────────────────────────────────────────────┐
│                    Redis 预扣减流程                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Redis DECR session:{id}:quota                       │
│     │                                                   │
│     ├─ >= 0 → 预扣成功，继续                            │
│     │         ├─ 数据库扣减成功 → 完成                   │
│     │         └─ 数据库扣减失败 → INCR 回退 Redis        │
│     │                                                   │
│     └─ < 0  → 名额不足，INCR 回退，返回失败              │
│                                                         │
│  2. 取消报名时 INCR 回退                                 │
│                                                         │
│  3. 定时任务同步 Redis 与 DB（兜底）                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 业务规则清单

### 4.1 认证与权限

| 规则编号 | 规则描述 | 影响范围 |
|----------|----------|----------|
| BR-AUTH-01 | 所有 API（除登录/注册）必须携带有效 JWT | 全局 |
| BR-AUTH-02 | JWT 有效期 24 小时，支持刷新 | 认证模块 |
| BR-AUTH-03 | 密码错误 5 次锁定账户 30 分钟 | 登录接口 |
| BR-AUTH-04 | 角色权限矩阵见下表 | 全局 |

**权限矩阵：**

| 功能 | ADMIN | INSTRUCTOR | STUDENT |
|------|-------|------------|---------|
| 用户管理 | ✅ CRUD | ❌ | ❌ |
| 课程管理 | ✅ CRUD | ❌ 只读 | ❌ 只读（上架） |
| 班期管理 | ✅ CRUD | ❌ 只读（自己的） | ❌ 只读（报名中） |
| 报名管理 | ✅ 全部 | ❌ 只读（自己班期） | ✅ 自己的 |
| 统计看板 | ✅ | ❌ | ❌ |
| AI 推荐 | ❌ | ❌ | ✅ |

### 4.2 课程规则

| 规则编号 | 规则描述 |
|----------|----------|
| BR-COURSE-01 | 课程编码格式：`{类别缩写}-{3位序号}`，如 JAVA-001 |
| BR-COURSE-02 | 课程分类枚举：BACKEND/FRONTEND/DATABASE/CLOUD/AI/OTHER |
| BR-COURSE-03 | 难度等级 1-4，用于 AI 推荐排序 |
| BR-COURSE-04 | 下架课程对学员不可见，已报名学员不受影响 |

### 4.3 班期规则

| 规则编号 | 规则描述 |
|----------|----------|
| BR-SESSION-01 | 班期编码格式：`{课程编码}-{年份}S{序号}`，如 JAVA-001-2024S1 |
| BR-SESSION-02 | 每个班期必须关联一名讲师 |
| BR-SESSION-03 | 开班日期必须是未来日期 |
| BR-SESSION-04 | 满员自动更新状态为"已满员" |
| BR-SESSION-05 | 定时任务：开班日期到达时状态变"进行中" |
| BR-SESSION-06 | 定时任务：结束日期到达时状态变"已结束" |

### 4.4 报名规则

| 规则编号 | 规则描述 |
|----------|----------|
| BR-ENROLL-01 | 仅 STUDENT 角色可报名 |
| BR-ENROLL-02 | 禁止重复报名同一班期 |
| BR-ENROLL-03 | 禁止报名已满班期 |
| BR-ENROLL-04 | 禁止报名非"报名中"状态班期 |
| BR-ENROLL-05 | 取消报名立即释放名额 |
| BR-ENROLL-06 | 班期已开始后禁止取消 |

### 4.5 AI 推荐规则

| 规则编号 | 规则描述 |
|----------|----------|
| BR-AI-01 | 推荐基于用户输入的学习目标 |
| BR-AI-02 | 返回 3-5 门推荐课程 |
| BR-AI-03 | 返回结果包含：课程列表、推荐理由、建议学习顺序 |
| BR-AI-04 | AI 超时(>10s)或不可用时，返回热门课程（按报名量排序） |
| BR-AI-05 | 所有推荐请求必须记录日志 |

---

## 5. 边界与不做项

### 5.1 MVP 范围内（必须实现）

- ✅ 三角色认证（ADMIN/INSTRUCTOR/STUDENT）
- ✅ 课程 CRUD（管理端）
- ✅ 班期 CRUD（管理端）
- ✅ 报名/取消（学员端）
- ✅ 名额控制（数据库事务方案）
- ✅ AI 推荐（单次推荐 + 日志）
- ✅ 简版统计（课程热度、报名趋势）

### 5.2 二期规划（MVP 不做）

- ⏳ 支付功能
- ⏳ 课程评价/评分
- ⏳ 学习进度跟踪
- ⏳ 消息通知（站内信/邮件/短信）
- ⏳ 优惠券/促销
- ⏳ 多租户
- ⏳ Redis 名额预扣减
- ⏳ 课程视频播放

### 5.3 明确不做

- ❌ 移动端 App
- ❌ 第三方登录（微信/支付宝）
- ❌ 直播功能
- ❌ 复杂审批流程
- ❌ 数据导入导出（Excel）

---

## 6. 术语统一表

| 术语 | 英文 | 定义 | 备注 |
|------|------|------|------|
| 课程 | Course | 培训内容的抽象定义，如"Java基础" | 不含具体时间安排 |
| 班期 | ClassSession | 课程的一次具体开班，含时间、讲师、名额 | 学员报名的实际对象 |
| 报名 | Enrollment | 学员选择某班期的行为记录 | 状态：已报名/已取消 |
| 名额 | Quota/Capacity | 班期可容纳的最大学员数 | max_capacity |
| 学员 | Student | 角色为 STUDENT 的用户 | 可浏览、报名、获取推荐 |
| 讲师 | Instructor | 角色为 INSTRUCTOR 的用户 | 负责班期授课 |
| 管理员 | Admin | 角色为 ADMIN 的用户 | 系统管理权限 |
| AI 推荐 | AI Recommendation | 基于学习目标的智能课程推荐 | 返回课程+理由+顺序 |
| 上架 | Published | 课程对学员可见状态 | status=1 |
| 下架 | Unpublished | 课程对学员不可见状态 | status=0 |

---

## 7. 与 easy-enroll 业务术语映射

> **说明**：本表对齐 easy-enroll 项目的业务概念，仅做术语/概念层面映射，不涉及代码复制。

| 本项目术语 | easy-enroll 对应概念 | 对齐说明 |
|------------|---------------------|----------|
| Course（课程） | 活动/项目 | 都是报名的顶层对象 |
| ClassSession（班期） | 场次/批次 | 都是具体可报名的时间单元 |
| Enrollment（报名） | 报名记录 | 核心业务实体，状态机相似 |
| max_capacity（最大名额） | 名额上限 | 名额控制的核心字段 |
| current_enrollment（当前人数） | 已报名人数 | 冗余字段，便于查询 |
| ENROLLED（已报名） | 已报名/待审核 | 本项目简化，无审核流程 |
| CANCELED（已取消） | 已取消 | 状态一致 |
| User.role（用户角色） | 用户类型 | ADMIN/操作员、普通用户 |
| 软删除（deleted） | 逻辑删除 | 数据不物理删除 |

**仿照的业务模式：**

| # | 仿照点 | 说明 |
|---|--------|------|
| 1 | 课程-班期二级结构 | 课程为模板，班期为实例 |
| 2 | 名额实时控制 | 报名扣减、取消回退 |
| 3 | 报名状态机 | 简化为已报名→已取消 |
| 4 | 冗余计数字段 | current_enrollment 避免 COUNT 查询 |
| 5 | 软删除策略 | 保留历史数据完整性 |

---

## 修订记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v1.0.0 | 2025-12-14 | BA | 初始版本 |

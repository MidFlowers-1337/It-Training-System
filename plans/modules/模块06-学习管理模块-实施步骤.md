# 模块06：学习管理模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块04（课程管理模块）已完成
- ✅ 模块05（选课管理模块）已完成

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V5__create_study_tables.sql`
- [ ] 编写study_progress表创建SQL
  ```sql
  CREATE TABLE study_progress (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    enrollment_id BIGINT NOT NULL COMMENT '选课记录ID',
    chapter_id BIGINT NOT NULL COMMENT '章节ID',
    resource_id BIGINT COMMENT '资源ID',
    progress DECIMAL(5,2) DEFAULT 0.00 COMMENT '进度(%)',
    study_duration INT DEFAULT 0 COMMENT '学习时长(秒)',
    is_completed TINYINT DEFAULT 0 COMMENT '是否完成',
    last_position INT DEFAULT 0 COMMENT '视频播放位置(秒)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_enrollment_chapter_resource (enrollment_id, chapter_id, resource_id),
    KEY idx_enrollment_id (enrollment_id),
    KEY idx_chapter_id (chapter_id)
  ) COMMENT='学习进度表';
  ```

- [ ] 编写study_note表创建SQL
  ```sql
  CREATE TABLE study_note (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    chapter_id BIGINT COMMENT '章节ID',
    note_title VARCHAR(200) COMMENT '笔记标题',
    note_content TEXT NOT NULL COMMENT '笔记内容',
    video_time INT COMMENT '视频时间点(秒)',
    is_public TINYINT DEFAULT 0 COMMENT '是否公开',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_student_id (student_id),
    KEY idx_course_id (course_id),
    KEY idx_is_public (is_public)
  ) COMMENT='学习笔记表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建

---

## 二、实体类创建

### 2.1 创建StudyProgress实体
- [ ] 创建 `entity/StudyProgress.java`
- [ ] 定义所有字段
- [ ] 添加注解

### 2.2 创建StudyNote实体
- [ ] 创建 `entity/StudyNote.java`
- [ ] 定义所有字段
- [ ] 添加注解

---

## 三、DTO类创建

### 3.1 学习进度DTO
- [ ] 创建 `dto/request/StudyProgressUpdateRequest.java`
  ```java
  - enrollmentId: Long (@NotNull)
  - chapterId: Long (@NotNull)
  - resourceId: Long
  - progress: BigDecimal
  - studyDuration: Integer (本次学习时长，秒)
  - lastPosition: Integer (视频播放位置)
  ```

### 3.2 学习笔记DTO
- [ ] 创建 `dto/request/StudyNoteCreateRequest.java`
  ```java
  - courseId: Long (@NotNull)
  - chapterId: Long
  - noteTitle: String
  - noteContent: String (@NotBlank)
  - videoTime: Integer
  - isPublic: Boolean
  ```

- [ ] 创建 `dto/request/StudyNoteUpdateRequest.java`
- [ ] 创建 `dto/request/StudyNoteQueryRequest.java`

### 3.3 响应VO
- [ ] 创建 `vo/StudyProgressVO.java`
- [ ] 创建 `vo/ChapterProgressVO.java`
- [ ] 创建 `vo/StudyNoteVO.java`
- [ ] 创建 `vo/StudyCalendarVO.java`

---

## 四、Mapper层实现

### 4.1 创建StudyProgressMapper
- [ ] 创建 `mapper/StudyProgressMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(StudyProgress progress)
  - updateById(StudyProgress progress)
  - selectById(Long id)
  - selectByEnrollmentAndChapter(Long enrollmentId, Long chapterId, Long resourceId)
  - selectByEnrollmentId(Long enrollmentId)
  - calculateTotalProgress(Long enrollmentId)
  - selectCompletedChapters(Long enrollmentId)
  ```

- [ ] 创建 `resources/mapper/StudyProgressMapper.xml`
- [ ] 编写SQL语句

### 4.2 创建StudyNoteMapper
- [ ] 创建 `mapper/StudyNoteMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(StudyNote note)
  - updateById(StudyNote note)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCondition(StudyNoteQueryRequest request)
  - selectPublicNotes(Long courseId, PageHelper)
  ```

- [ ] 创建 `resources/mapper/StudyNoteMapper.xml`

---

## 五、Service层实现

### 5.1 创建StudyService接口
- [ ] 创建 `service/IStudyService.java`
- [ ] 定义方法：
  ```java
  - void updateProgress(StudyProgressUpdateRequest request)
  - StudyProgressVO getStudyProgress(Long enrollmentId)
  - ChapterProgressVO getChapterProgress(Long enrollmentId, Long chapterId)
  - void completeChapter(Long enrollmentId, Long chapterId)
  - Map<String, Object> getStudyCalendar(Long studentId, String month)
  ```

### 5.2 实现StudyService
- [ ] 创建 `service/impl/StudyServiceImpl.java`
- [ ] 实现updateProgress方法：
  ```java
  - 查询或创建学习进度记录
  - 更新进度和学习时长
  - 判断章节是否完成
  - 计算课程总进度
  - 更新enrollment表的progress字段
  - 更新lastStudyTime
  ```

- [ ] 实现getStudyProgress方法：
  ```java
  - 查询所有章节进度
  - 计算总进度
  - 统计已完成章节数
  - 返回StudyProgressVO
  ```

- [ ] 实现completeChapter方法：
  ```java
  - 标记章节为已完成
  - 重新计算课程进度
  - 检查是否完成整个课程
  - 如果完成，更新enrollment状态
  ```

- [ ] 实现getStudyCalendar方法：
  ```java
  - 查询指定月份的学习记录
  - 按日期分组统计学习时长
  - 返回日历数据
  ```

### 5.3 创建StudyNoteService
- [ ] 创建 `service/IStudyNoteService.java`
- [ ] 定义方法：
  ```java
  - Long createNote(StudyNoteCreateRequest request)
  - void updateNote(Long id, StudyNoteUpdateRequest request)
  - void deleteNote(Long id)
  - PageResult<StudyNoteVO> getNoteList(StudyNoteQueryRequest request)
  - PageResult<StudyNoteVO> getPublicNotes(Long courseId, Integer pageNum, Integer pageSize)
  ```

- [ ] 创建 `service/impl/StudyNoteServiceImpl.java`
- [ ] 实现所有方法

---

## 六、Controller层实现

### 6.1 创建StudyController
- [ ] 创建 `controller/StudyController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/study")
  @RequireLogin
  ```

- [ ] 实现GET /api/study/courses/{courseId}/chapters接口（获取章节列表）
- [ ] 实现GET /api/study/chapters/{chapterId}/resources接口（获取资源列表）
- [ ] 实现POST /api/study/progress接口（更新学习进度）
- [ ] 实现GET /api/study/progress/{enrollmentId}接口（获取学习进度）
- [ ] 实现POST /api/study/notes接口（创建笔记）
- [ ] 实现GET /api/study/notes接口（我的笔记列表）
- [ ] 实现PUT /api/study/notes/{id}接口（更新笔记）
- [ ] 实现DELETE /api/study/notes/{id}接口（删除笔记）
- [ ] 实现GET /api/study/calendar接口（学习日历）
- [ ] 实现GET /api/study/notes/public接口（公开笔记）

---

## 七、测试

### 7.1 单元测试
- [ ] 测试StudyProgressMapper的CRUD方法
- [ ] 测试StudyService的进度计算
- [ ] 测试StudyNoteService的CRUD方法

### 7.2 接口测试
- [ ] 测试更新学习进度
- [ ] 测试获取学习进度
- [ ] 测试完成章节
- [ ] 测试笔记管理
- [ ] 测试学习日历

---

## 八、文档更新

### 8.1 Swagger文档
- [ ] 为所有接口添加@Operation注解
- [ ] 添加请求/响应示例

### 8.2 接口文档
- [ ] 编写学习管理接口文档
- [ ] 说明进度计算规则

---

## 九、Git提交

### 9.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成学习管理模块"
- [ ] git push

---

## 验收标准

- ✅ 学员能更新学习进度
- ✅ 学员能查看学习进度
- ✅ 学员能创建和管理笔记
- ✅ 学员能查看学习日历
- ✅ 进度计算正确
- ✅ 所有接口测试通过
- ✅ 单元测试覆盖率>80%

---

## 预计耗时

- **总计：3-4天**
  - 数据库和实体类：0.5天
  - Mapper和Service层：1.5天
  - Controller层：0.5天
  - 测试和文档：1天

---

## 下一步

完成本模块后，进入 **模块07：技能评估模块**
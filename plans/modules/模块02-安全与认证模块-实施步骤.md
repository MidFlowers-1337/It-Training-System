# 模块02：安全与认证模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 数据库连接已配置
- ✅ Redis已配置

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V1__init_user_tables.sql`
- [ ] 编写user表创建SQL
- [ ] 编写role表创建SQL
- [ ] 编写user_role表创建SQL
- [ ] 添加必要的索引

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建
- [ ] 插入初始角色数据（admin, teacher, student）

---

## 二、实体类创建

### 2.1 创建User实体
- [ ] 创建 `entity/User.java`
- [ ] 定义字段：id, username, password, realName, phone, email, avatar, gender, birthDate, status, createTime, updateTime
- [ ] 添加@Table和@Column注解
- [ ] 添加getter/setter
- [ ] 添加@Data注解（Lombok）

### 2.2 创建Role实体
- [ ] 创建 `entity/Role.java`
- [ ] 定义字段：id, roleName, roleCode, description, status, createTime, updateTime
- [ ] 添加注解

### 2.3 创建UserRole实体
- [ ] 创建 `entity/UserRole.java`
- [ ] 定义字段：id, userId, roleId, createTime
- [ ] 添加注解

---

## 三、DTO类创建

### 3.1 创建请求DTO
- [ ] 创建 `dto/request/LoginRequest.java`
  - username, password, captcha
  - 添加@NotBlank校验注解

- [ ] 创建 `dto/request/RegisterRequest.java`
  - username, password, confirmPassword, realName, phone, email
  - 添加校验注解

- [ ] 创建 `dto/request/ResetPasswordRequest.java`
  - phone/email, code, newPassword
  - 添加校验注解

### 3.2 创建响应DTO
- [ ] 创建 `dto/response/LoginResponse.java`
  - token, userInfo, expiresIn

- [ ] 创建 `vo/UserInfoVO.java`
  - 用户基本信息（不含密码）
  - 角色列表
  - 权限列表

---

## 四、Mapper层实现

### 4.1 创建UserMapper
- [ ] 创建 `mapper/UserMapper.java` 接口
- [ ] 定义方法：
  - selectById(Long id)
  - selectByUsername(String username)
  - selectByPhone(String phone)
  - selectByEmail(String email)
  - insert(User user)
  - updateById(User user)
  - deleteById(Long id)

- [ ] 创建 `resources/mapper/UserMapper.xml`
- [ ] 编写对应的SQL语句

### 4.2 创建RoleMapper
- [ ] 创建 `mapper/RoleMapper.java` 接口
- [ ] 创建 `resources/mapper/RoleMapper.xml`
- [ ] 实现基础CRUD方法

### 4.3 创建UserRoleMapper
- [ ] 创建 `mapper/UserRoleMapper.java` 接口
- [ ] 创建 `resources/mapper/UserRoleMapper.xml`
- [ ] 实现方法：
  - selectRolesByUserId(Long userId)
  - insertBatch(List<UserRole> userRoles)
  - deleteByUserId(Long userId)

---

## 五、Service层实现

### 5.1 创建AuthService接口
- [ ] 创建 `service/IAuthService.java`
- [ ] 定义方法：
  - register(RegisterRequest request)
  - login(LoginRequest request)
  - logout(String token)
  - refreshToken(String token)
  - sendVerificationCode(String phone)
  - resetPassword(ResetPasswordRequest request)

### 5.2 实现AuthService
- [ ] 创建 `service/impl/AuthServiceImpl.java`
- [ ] 实现register方法：
  - 检查用户名唯一性
  - 检查手机号/邮箱唯一性
  - 密码加密（BCrypt）
  - 创建用户
  - 分配默认角色（student）
  - 返回成功信息

- [ ] 实现login方法：
  - 验证用户名密码
  - 验证验证码（可选）
  - 查询用户角色
  - 生成JWT token
  - 将token存入Redis（设置过期时间）
  - 记录登录日志
  - 返回LoginResponse

- [ ] 实现logout方法：
  - 将token加入黑名单（Redis）
  - 删除token缓存
  - 返回成功信息

- [ ] 实现refreshToken方法：
  - 验证旧token
  - 生成新token
  - 更新Redis缓存
  - 返回新token

- [ ] 实现sendVerificationCode方法：
  - 生成6位随机验证码
  - 存入Redis（5分钟过期）
  - 发送短信/邮件（可模拟）
  - 返回成功信息

- [ ] 实现resetPassword方法：
  - 验证验证码
  - 查询用户
  - 更新密码（加密）
  - 返回成功信息

---

## 六、Spring Security配置

### 6.1 创建SecurityConfig
- [ ] 创建 `config/SecurityConfig.java`
- [ ] 添加@Configuration和@EnableWebSecurity注解
- [ ] 配置密码编码器Bean（BCryptPasswordEncoder）
- [ ] 配置认证管理器Bean
- [ ] 配置SecurityFilterChain：
  - 禁用CSRF
  - 配置会话管理（STATELESS）
  - 配置放行路径（/api/auth/**, /swagger-ui/**, /v3/api-docs/**）
  - 其他路径需要认证
  - 添加JWT过滤器

### 6.2 创建JWT过滤器
- [ ] 创建 `config/JwtAuthenticationFilter.java`
- [ ] 继承OncePerRequestFilter
- [ ] 实现doFilterInternal方法：
  - 从请求头获取token（Authorization: Bearer xxx）
  - 验证token有效性
  - 检查token是否在黑名单
  - 解析用户信息
  - 设置到SecurityContext
  - 继续过滤链

- [ ] 处理异常：
  - token过期
  - token无效
  - token被篡改

---

## 七、Controller层实现

### 7.1 创建AuthController
- [ ] 创建 `controller/AuthController.java`
- [ ] 添加@RestController和@RequestMapping("/api/auth")注解
- [ ] 注入AuthService

- [ ] 实现POST /register接口
  - 接收RegisterRequest
  - 参数校验
  - 调用service.register()
  - 返回Result

- [ ] 实现POST /login接口
  - 接收LoginRequest
  - 参数校验
  - 调用service.login()
  - 返回Result<LoginResponse>

- [ ] 实现POST /logout接口
  - 从请求头获取token
  - 调用service.logout()
  - 返回Result

- [ ] 实现POST /refresh接口
  - 从请求头获取token
  - 调用service.refreshToken()
  - 返回Result<String>

- [ ] 实现GET /captcha接口
  - 生成图形验证码
  - 存入Redis
  - 返回Base64图片

- [ ] 实现POST /send-code接口
  - 接收phone/email
  - 调用service.sendVerificationCode()
  - 返回Result

- [ ] 实现POST /reset-password接口
  - 接收ResetPasswordRequest
  - 调用service.resetPassword()
  - 返回Result

---

## 八、权限控制

### 8.1 创建权限注解
- [ ] 创建 `common/annotation/RequireLogin.java`
  - @Target(ElementType.METHOD)
  - @Retention(RetentionPolicy.RUNTIME)

- [ ] 创建 `common/annotation/RequireRole.java`
  - value: String[] (角色列表)
  - logical: Logical.AND/OR

### 8.2 创建权限切面
- [ ] 创建 `aspect/AuthAspect.java`
- [ ] 添加@Aspect和@Component注解
- [ ] 实现@Around("@annotation(RequireLogin)")
  - 从SecurityContext获取当前用户
  - 未登录抛出NOT_LOGIN异常

- [ ] 实现@Around("@annotation(RequireRole)")
  - 获取当前用户角色
  - 验证是否拥有所需角色
  - 无权限抛出NO_AUTH异常

---

## 九、工具类完善

### 9.1 完善JwtUtil
- [ ] 配置JWT密钥（从配置文件读取）
- [ ] 配置token过期时间（7天）
- [ ] 实现generateToken方法
- [ ] 实现parseToken方法
- [ ] 实现validateToken方法
- [ ] 实现refreshToken方法
- [ ] 处理各种JWT异常

### 9.2 完善PasswordUtil
- [ ] 实现encode方法（BCrypt）
- [ ] 实现matches方法
- [ ] 添加密码强度校验方法

---

## 十、测试

### 10.1 单元测试
- [ ] 测试UserMapper的CRUD方法
- [ ] 测试AuthService的register方法
- [ ] 测试AuthService的login方法
- [ ] 测试JwtUtil的token生成和解析
- [ ] 测试PasswordUtil的加密和验证

### 10.2 接口测试
- [ ] 使用Postman测试注册接口
  - 正常注册
  - 用户名重复
  - 参数校验

- [ ] 测试登录接口
  - 正常登录
  - 用户名错误
  - 密码错误
  - 验证码错误

- [ ] 测试登出接口
  - 正常登出
  - token失效后再次访问

- [ ] 测试刷新token接口
  - 正常刷新
  - 过期token刷新

- [ ] 测试找回密码接口
  - 发送验证码
  - 重置密码

### 10.3 权限测试
- [ ] 测试未登录访问需要认证的接口
- [ ] 测试普通用户访问管理员接口
- [ ] 测试@RequireRole注解

---

## 十一、安全加固

### 11.1 密码安全
- [ ] 密码长度限制（8-20位）
- [ ] 密码复杂度要求（字母+数字）
- [ ] 密码加盐（BCrypt自动处理）

### 11.2 登录安全
- [ ] 登录失败次数限制（Redis记录）
- [ ] 账号锁定机制（5次失败锁定30分钟）
- [ ] 验证码机制

### 11.3 Token安全
- [ ] Token过期时间设置
- [ ] Token刷新机制
- [ ] Token黑名单机制
- [ ] 防止token被盗用（IP绑定可选）

---

## 十二、文档更新

### 12.1 Swagger文档
- [ ] 为所有接口添加@Operation注解
- [ ] 添加请求参数说明
- [ ] 添加响应示例
- [ ] 添加错误码说明

### 12.2 接口文档
- [ ] 编写认证接口文档
- [ ] 说明token使用方式
- [ ] 说明权限控制规则

---

## 十三、Git提交

### 13.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成安全与认证模块"
- [ ] git push

---

## 验收标准

- ✅ 用户能正常注册
- ✅ 用户能正常登录并获取token
- ✅ token能正常验证
- ✅ 用户能正常登出
- ✅ token能正常刷新
- ✅ 找回密码功能正常
- ✅ 权限控制生效
- ✅ 所有接口测试通过
- ✅ 单元测试覆盖率>80%
- ✅ Swagger文档完整

---

## 预计耗时

- **总计：5-7天**
  - 数据库和实体类：1天
  - Mapper和Service层：2天
  - Security配置和JWT：1天
  - Controller和权限控制：1天
  - 测试和安全加固：1-2天
  - 文档编写：0.5天

---

## 下一步

完成本模块后，进入 **模块03：用户管理模块**
# 模块10：支付管理模块 - 实施步骤（可选）

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块04（课程管理模块）已完成
- ✅ 模块05（选课管理模块）已完成
- ✅ 支付宝沙箱账号已申请

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V9__create_payment_tables.sql`
- [ ] 编写order_info表创建SQL
  ```sql
  CREATE TABLE order_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    order_amount DECIMAL(10,2) NOT NULL COMMENT '订单金额',
    discount_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '优惠金额',
    actual_amount DECIMAL(10,2) NOT NULL COMMENT '实付金额',
    payment_method TINYINT COMMENT '支付方式：1-支付宝，2-微信',
    payment_status TINYINT DEFAULT 0 COMMENT '支付状态：0-未支付，1-已支付，2-已退款',
    trade_no VARCHAR(100) COMMENT '第三方交易号',
    payment_time DATETIME COMMENT '支付时间',
    refund_time DATETIME COMMENT '退款时间',
    order_status TINYINT DEFAULT 1 COMMENT '订单状态：1-待支付，2-已完成，3-已取消，4-已退款',
    remark VARCHAR(500) COMMENT '备注',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_course_id (course_id),
    KEY idx_order_no (order_no),
    KEY idx_payment_status (payment_status)
  ) COMMENT='订单表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建

---

## 二、实体类创建

### 2.1 创建OrderInfo实体
- [ ] 创建 `entity/OrderInfo.java`
- [ ] 定义所有字段
- [ ] 添加注解

---

## 三、DTO类创建

### 3.1 订单DTO
- [ ] 创建 `dto/request/OrderCreateRequest.java`
  ```java
  - courseId: Long (@NotNull)
  - paymentMethod: Integer (@NotNull)
  ```

- [ ] 创建 `dto/request/PaymentCallbackRequest.java`
  ```java
  - 支付宝回调参数
  ```

- [ ] 创建 `dto/request/RefundRequest.java`
  ```java
  - orderNo: String (@NotBlank)
  - refundReason: String
  ```

### 3.2 响应VO
- [ ] 创建 `vo/OrderVO.java`
  ```java
  - 订单信息
  - 课程信息: CourseVO
  - 用户信息: UserInfoVO
  ```

- [ ] 创建 `vo/PaymentVO.java`
  ```java
  - orderNo: String
  - paymentUrl: String (支付链接)
  - qrCode: String (二维码)
  ```

---

## 四、支付宝配置

### 4.1 添加支付宝依赖
- [ ] 在pom.xml中添加
  ```xml
  <dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.38.10.ALL</version>
  </dependency>
  ```

### 4.2 创建支付宝配置类
- [ ] 创建 `config/AlipayConfig.java`
  ```java
  @Configuration
  @ConfigurationProperties(prefix = "alipay")
  @Data
  public class AlipayConfig {
    private String appId;
    private String privateKey;
    private String publicKey;
    private String gatewayUrl;
    private String notifyUrl;
    private String returnUrl;
    private String signType = "RSA2";
    private String charset = "UTF-8";
    private String format = "json";
    
    @Bean
    public AlipayClient alipayClient() {
      return new DefaultAlipayClient(
        gatewayUrl,
        appId,
        privateKey,
        format,
        charset,
        publicKey,
        signType
      );
    }
  }
  ```

### 4.3 配置application.yaml
- [ ] 添加支付宝配置
  ```yaml
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    public-key: ${ALIPAY_PUBLIC_KEY}
    gateway-url: https://openapi.alipaydev.com/gateway.do
    notify-url: ${SERVER_URL}/api/payment/alipay/callback
    return-url: ${FRONTEND_URL}/payment/success
  ```

---

## 五、Mapper层实现

### 5.1 创建OrderMapper
- [ ] 创建 `mapper/OrderMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(OrderInfo order)
  - updateById(OrderInfo order)
  - selectById(Long id)
  - selectByOrderNo(String orderNo)
  - selectByUserId(Long userId, PageHelper)
  - updatePaymentStatus(String orderNo, Integer status, String tradeNo)
  - selectUnpaidOrders(LocalDateTime before)
  ```

- [ ] 创建 `resources/mapper/OrderMapper.xml`
- [ ] 编写SQL语句

---

## 六、Service层实现

### 6.1 创建PaymentService接口
- [ ] 创建 `service/IPaymentService.java`
- [ ] 定义方法：
  ```java
  - String createOrder(Long userId, Long courseId)
  - OrderVO getOrderByNo(String orderNo)
  - PaymentVO alipayPay(String orderNo)
  - void handleAlipayCallback(Map<String, String> params)
  - void refundOrder(String orderNo, String refundReason)
  - PageResult<OrderVO> getMyOrders(Long userId, Integer pageNum, Integer pageSize)
  - void cancelUnpaidOrders()
  ```

### 6.2 实现PaymentService
- [ ] 创建 `service/impl/PaymentServiceImpl.java`
- [ ] 实现createOrder方法：
  ```java
  @Override
  public String createOrder(Long userId, Long courseId) {
    // 1. 检查是否已选课
    Enrollment enrollment = enrollmentMapper.selectByStudentAndCourse(userId, courseId);
    if (enrollment != null) {
      throw new BusinessException(ErrorCode.PARAMS_ERROR, "已选过该课程");
    }
    
    // 2. 查询课程信息
    Course course = courseMapper.selectById(courseId);
    if (course == null) {
      throw new BusinessException(ErrorCode.NOT_FOUND, "课程不存在");
    }
    
    // 3. 生成订单号
    String orderNo = generateOrderNo();
    
    // 4. 计算金额
    BigDecimal orderAmount = course.getPrice();
    BigDecimal discountAmount = BigDecimal.ZERO;
    BigDecimal actualAmount = orderAmount.subtract(discountAmount);
    
    // 5. 创建订单
    OrderInfo order = new OrderInfo();
    order.setOrderNo(orderNo);
    order.setUserId(userId);
    order.setCourseId(courseId);
    order.setOrderAmount(orderAmount);
    order.setDiscountAmount(discountAmount);
    order.setActualAmount(actualAmount);
    order.setPaymentStatus(0);
    order.setOrderStatus(1);
    
    orderMapper.insert(order);
    
    return orderNo;
  }
  
  private String generateOrderNo() {
    // 订单号格式：yyyyMMddHHmmss + 6位随机数
    String timestamp = LocalDateTime.now().format(
      DateTimeFormatter.ofPattern("yyyyMMddHHmmss")
    );
    String random = String.format("%06d", new Random().nextInt(1000000));
    return "ORD" + timestamp + random;
  }
  ```

- [ ] 实现alipayPay方法：
  ```java
  @Override
  public PaymentVO alipayPay(String orderNo) {
    // 1. 查询订单
    OrderInfo order = orderMapper.selectByOrderNo(orderNo);
    if (order == null) {
      throw new BusinessException(ErrorCode.NOT_FOUND, "订单不存在");
    }
    
    // 2. 检查订单状态
    if (order.getPaymentStatus() == 1) {
      throw new BusinessException(ErrorCode.PARAMS_ERROR, "订单已支付");
    }
    
    // 3. 查询课程信息
    Course course = courseMapper.selectById(order.getCourseId());
    
    // 4. 构建支付宝请求
    AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
    request.setNotifyUrl(alipayConfig.getNotifyUrl());
    request.setReturnUrl(alipayConfig.getReturnUrl());
    
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", orderNo);
    bizContent.put("total_amount", order.getActualAmount());
    bizContent.put("subject", course.getCourseName());
    bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
    
    request.setBizContent(bizContent.toString());
    
    // 5. 调用支付宝API
    try {
      AlipayTradePagePayResponse response = alipayClient.pageExecute(request);
      
      PaymentVO vo = new PaymentVO();
      vo.setOrderNo(orderNo);
      vo.setPaymentUrl(response.getBody());
      
      return vo;
    } catch (AlipayApiException e) {
      log.error("调用支付宝API失败", e);
      throw new BusinessException(ErrorCode.SYSTEM_ERROR, "创建支付失败");
    }
  }
  ```

- [ ] 实现handleAlipayCallback方法：
  ```java
  @Override
  @Transactional
  public void handleAlipayCallback(Map<String, String> params) {
    // 1. 验签
    boolean signVerified = false;
    try {
      signVerified = AlipaySignature.rsaCheckV1(
        params,
        alipayConfig.getPublicKey(),
        alipayConfig.getCharset(),
        alipayConfig.getSignType()
      );
    } catch (AlipayApiException e) {
      log.error("支付宝回调验签失败", e);
      throw new BusinessException(ErrorCode.SYSTEM_ERROR, "验签失败");
    }
    
    if (!signVerified) {
      throw new BusinessException(ErrorCode.SYSTEM_ERROR, "验签失败");
    }
    
    // 2. 获取参数
    String orderNo = params.get("out_trade_no");
    String tradeNo = params.get("trade_no");
    String tradeStatus = params.get("trade_status");
    
    // 3. 查询订单
    OrderInfo order = orderMapper.selectByOrderNo(orderNo);
    if (order == null) {
      log.error("订单不存在：{}", orderNo);
      return;
    }
    
    // 4. 幂等性检查
    if (order.getPaymentStatus() == 1) {
      log.info("订单已支付，忽略回调：{}", orderNo);
      return;
    }
    
    // 5. 处理支付结果
    if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
      // 更新订单状态
      order.setPaymentStatus(1);
      order.setOrderStatus(2);
      order.setTradeNo(tradeNo);
      order.setPaymentTime(LocalDateTime.now());
      orderMapper.updateById(order);
      
      // 自动选课
      Enrollment enrollment = new Enrollment();
      enrollment.setStudentId(order.getUserId());
      enrollment.setCourseId(order.getCourseId());
      enrollment.setOrderId(order.getId());
      enrollment.setEnrollmentTime(LocalDateTime.now());
      enrollment.setStatus(1);
      enrollmentMapper.insert(enrollment);
      
      // 扣减课程库存
      courseMapper.decrementStock(order.getCourseId(), null);
      
      log.info("订单支付成功：{}", orderNo);
    }
  }
  ```

- [ ] 实现refundOrder方法：
  ```java
  @Override
  public void refundOrder(String orderNo, String refundReason) {
    // 1. 查询订单
    OrderInfo order = orderMapper.selectByOrderNo(orderNo);
    if (order == null) {
      throw new BusinessException(ErrorCode.NOT_FOUND, "订单不存在");
    }
    
    // 2. 检查订单状态
    if (order.getPaymentStatus() != 1) {
      throw new BusinessException(ErrorCode.PARAMS_ERROR, "订单未支付");
    }
    
    // 3. 构建退款请求
    AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();
    
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", orderNo);
    bizContent.put("refund_amount", order.getActualAmount());
    bizContent.put("refund_reason", refundReason);
    
    request.setBizContent(bizContent.toString());
    
    // 4. 调用支付宝退款API
    try {
      AlipayTradeRefundResponse response = alipayClient.execute(request);
      
      if (response.isSuccess()) {
        // 更新订单状态
        order.setPaymentStatus(2);
        order.setOrderStatus(4);
        order.setRefundTime(LocalDateTime.now());
        order.setRemark(refundReason);
        orderMapper.updateById(order);
        
        // 退课
        enrollmentMapper.deleteByOrderId(order.getId());
        
        // 恢复库存
        courseMapper.incrementStock(order.getCourseId());
        
        log.info("订单退款成功：{}", orderNo);
      } else {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "退款失败：" + response.getSubMsg());
      }
    } catch (AlipayApiException e) {
      log.error("调用支付宝退款API失败", e);
      throw new BusinessException(ErrorCode.SYSTEM_ERROR, "退款失败");
    }
  }
  ```

---

## 七、定时任务

### 7.1 创建订单超时取消任务
- [ ] 创建 `task/OrderCancelTask.java`
  ```java
  @Component
  public class OrderCancelTask {
    @Autowired
    private IPaymentService paymentService;
    
    @Scheduled(cron = "0 */10 * * * ?") // 每10分钟
    public void cancelUnpaidOrders() {
      paymentService.cancelUnpaidOrders();
    }
  }
  ```

- [ ] 在PaymentService中实现cancelUnpaidOrders方法：
  ```java
  @Override
  public void cancelUnpaidOrders() {
    // 查询30分钟前创建的未支付订单
    LocalDateTime before = LocalDateTime.now().minusMinutes(30);
    List<OrderInfo> unpaidOrders = orderMapper.selectUnpaidOrders(before);
    
    for (OrderInfo order : unpaidOrders) {
      order.setOrderStatus(3); // 已取消
      orderMapper.updateById(order);
      
      log.info("订单超时取消：{}", order.getOrderNo());
    }
  }
  ```

---

## 八、Controller层实现

### 8.1 创建PaymentController
- [ ] 创建 `controller/PaymentController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/payment")
  @RequireLogin
  ```

- [ ] 实现POST /api/payment/orders接口（创建订单）
- [ ] 实现GET /api/payment/orders/{orderNo}接口（查询订单）
- [ ] 实现POST /api/payment/alipay接口（支付宝支付）
- [ ] 实现POST /api/payment/alipay/callback接口（支付宝回调）
- [ ] 实现POST /api/payment/orders/{orderNo}/refund接口（申请退款）
- [ ] 实现GET /api/payment/orders/my接口（我的订单列表）

---

## 九、测试

### 9.1 单元测试
- [ ] 测试订单号生成
- [ ] 测试订单创建
- [ ] 测试支付回调处理

### 9.2 接口测试
- [ ] 测试创建订单
- [ ] 测试支付宝支付（沙箱环境）
- [ ] 测试支付回调
- [ ] 测试退款功能
- [ ] 测试订单超时取消

---

## 十、文档更新

### 10.1 Swagger文档
- [ ] 为所有接口添加@Operation注解

### 10.2 接口文档
- [ ] 编写支付管理接口文档
- [ ] 说明支付流程

---

## 十一、Git提交

### 11.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成支付管理模块"
- [ ] git push

---

## 验收标准

- ✅ 用户能创建订单
- ✅ 用户能使用支付宝支付
- ✅ 支付回调处理正常
- ✅ 支付成功自动选课
- ✅ 用户能申请退款
- ✅ 退款成功自动退课
- ✅ 订单超时自动取消
- ✅ 所有接口测试通过

---

## 预计耗时

- **总计：5-7天**
  - 数据库和实体类：0.5天
  - 支付宝集成：2天
  - Service层实现：2天
  - Controller层：0.5天
  - 测试和文档：1.5天

---

## 下一步

完成本模块后，进入 **模块11：数据统计模块**
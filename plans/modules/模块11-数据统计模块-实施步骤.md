# 模块11：数据统计模块 - 实施步骤

## 前置条件

- ✅ 所有业务模块已完成
- ✅ 数据已积累

---

## 一、数据库准备

### 1.1 创建统计视图（可选）
- [ ] 创建用户统计视图
- [ ] 创建课程统计视图
- [ ] 创建选课统计视图

---

## 二、DTO类创建

### 2.1 统计VO
- [ ] 创建 `vo/DashboardVO.java`
  ```java
  - userCount: Long (用户总数)
  - courseCount: Long (课程总数)
  - enrollmentCount: Long (选课总数)
  - todayNewUsers: Integer (今日新增用户)
  - todayEnrollments: Integer (今日选课数)
  - hotCourses: List<CourseVO> (热门课程Top10)
  - trendData: Map<String, List<Integer>> (趋势数据)
  ```

- [ ] 创建 `vo/CourseStatisticsVO.java`
  ```java
  - courseId: Long
  - courseName: String
  - enrollmentCount: Integer (选课人数)
  - completionCount: Integer (完成人数)
  - completionRate: BigDecimal (完成率)
  - avgStudyDuration: Integer (平均学习时长)
  - avgRating: BigDecimal (平均评分)
  - studentDistribution: Map<String, Integer> (学员分布)
  ```

- [ ] 创建 `vo/StudentStatisticsVO.java`
  ```java
  - studentId: Long
  - enrolledCourseCount: Integer (学习课程数)
  - completedCourseCount: Integer (完成课程数)
  - totalStudyDuration: Integer (总学习时长)
  - certificateCount: Integer (获得证书数)
  - skillTree: List<SkillVO> (技能树)
  - studyCalendar: Map<String, Integer> (学习日历)
  ```

- [ ] 创建 `vo/RevenueStatisticsVO.java`
  ```java
  - totalRevenue: BigDecimal (总收入)
  - todayRevenue: BigDecimal (今日收入)
  - monthRevenue: BigDecimal (本月收入)
  - revenueByMonth: Map<String, BigDecimal> (按月收入)
  - revenueByCategory: Map<String, BigDecimal> (按分类收入)
  ```

---

## 三、Mapper层实现

### 3.1 创建StatisticsMapper
- [ ] 创建 `mapper/StatisticsMapper.java` 接口
- [ ] 定义方法：
  ```java
  - countTotalUsers()
  - countTotalCourses()
  - countTotalEnrollments()
  - countTodayNewUsers()
  - countTodayEnrollments()
  - selectUserTrend(String startDate, String endDate)
  - selectEnrollmentTrend(String startDate, String endDate)
  - selectCourseStatistics(Long courseId)
  - selectStudentStatistics(Long studentId)
  - selectRevenueStatistics(String startDate, String endDate)
  - selectTopCourses(Integer limit)
  ```

- [ ] 创建 `resources/mapper/StatisticsMapper.xml`
- [ ] 编写复杂SQL查询：
  ```xml
  - 使用GROUP BY聚合
  - 使用COUNT、SUM、AVG函数
  - 使用DATE_FORMAT格式化日期
  - 多表关联查询
  ```

---

## 四、Service层实现

### 4.1 创建StatisticsService接口
- [ ] 创建 `service/IStatisticsService.java`
- [ ] 定义方法：
  ```java
  - DashboardVO getDashboardData()
  - Map<String, Object> getUserStatistics(String startDate, String endDate)
  - CourseStatisticsVO getCourseStatistics(Long courseId)
  - Map<String, Object> getEnrollmentStatistics(String startDate, String endDate)
  - StudentStatisticsVO getStudentStatistics(Long studentId)
  - RevenueStatisticsVO getRevenueStatistics(String startDate, String endDate)
  - byte[] exportReport(String type, Map<String, Object> params)
  ```

### 4.2 实现StatisticsService
- [ ] 创建 `service/impl/StatisticsServiceImpl.java`
- [ ] 实现getDashboardData方法：
  ```java
  @Override
  @Cacheable(value = "dashboard", key = "'data'", unless = "#result == null")
  public DashboardVO getDashboardData() {
    DashboardVO vo = new DashboardVO();
    
    // 1. 基础统计
    vo.setUserCount(statisticsMapper.countTotalUsers());
    vo.setCourseCount(statisticsMapper.countTotalCourses());
    vo.setEnrollmentCount(statisticsMapper.countTotalEnrollments());
    vo.setTodayNewUsers(statisticsMapper.countTodayNewUsers());
    vo.setTodayEnrollments(statisticsMapper.countTodayEnrollments());
    
    // 2. 热门课程
    List<Course> hotCourses = statisticsMapper.selectTopCourses(10);
    vo.setHotCourses(convertToCourseVO(hotCourses));
    
    // 3. 趋势数据（最近7天）
    String endDate = LocalDate.now().toString();
    String startDate = LocalDate.now().minusDays(6).toString();
    
    Map<String, List<Integer>> trendData = new HashMap<>();
    trendData.put("users", statisticsMapper.selectUserTrend(startDate, endDate));
    trendData.put("enrollments", statisticsMapper.selectEnrollmentTrend(startDate, endDate));
    vo.setTrendData(trendData);
    
    return vo;
  }
  ```

- [ ] 实现getCourseStatistics方法：
  ```java
  @Override
  public CourseStatisticsVO getCourseStatistics(Long courseId) {
    // 查询课程统计数据
    CourseStatisticsVO vo = statisticsMapper.selectCourseStatistics(courseId);
    
    // 计算完成率
    if (vo.getEnrollmentCount() > 0) {
      BigDecimal rate = BigDecimal.valueOf(vo.getCompletionCount())
        .divide(BigDecimal.valueOf(vo.getEnrollmentCount()), 2, RoundingMode.HALF_UP)
        .multiply(BigDecimal.valueOf(100));
      vo.setCompletionRate(rate);
    }
    
    return vo;
  }
  ```

- [ ] 实现exportReport方法（使用EasyExcel）：
  ```java
  @Override
  public byte[] exportReport(String type, Map<String, Object> params) {
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    
    try {
      if ("user".equals(type)) {
        // 导出用户报表
        List<UserStatisticsVO> data = getUserReportData(params);
        EasyExcel.write(outputStream, UserStatisticsVO.class)
          .sheet("用户统计")
          .doWrite(data);
      } else if ("course".equals(type)) {
        // 导出课程报表
        List<CourseStatisticsVO> data = getCourseReportData(params);
        EasyExcel.write(outputStream, CourseStatisticsVO.class)
          .sheet("课程统计")
          .doWrite(data);
      }
      
      return outputStream.toByteArray();
    } catch (Exception e) {
      log.error("导出报表失败", e);
      throw new BusinessException(ErrorCode.SYSTEM_ERROR, "导出失败");
    }
  }
  ```

---

## 五、缓存优化

### 5.1 添加缓存注解
- [ ] 在StatisticsService方法上添加@Cacheable
  ```java
  @Cacheable(value = "statistics:dashboard", key = "'data'", unless = "#result == null")
  public DashboardVO getDashboardData() { ... }
  
  @Cacheable(value = "statistics:course", key = "#courseId", unless = "#result == null")
  public CourseStatisticsVO getCourseStatistics(Long courseId) { ... }
  ```

### 5.2 创建缓存刷新任务
- [ ] 创建 `task/StatisticsCacheTask.java`
  ```java
  @Component
  public class StatisticsCacheTask {
    @Autowired
    private CacheManager cacheManager;
    
    @Scheduled(cron = "0 0 */1 * * ?") // 每小时
    public void refreshDashboardCache() {
      Cache cache = cacheManager.getCache("statistics:dashboard");
      if (cache != null) {
        cache.clear();
      }
      log.info("控制台缓存已刷新");
    }
  }
  ```

---

## 六、Controller层实现

### 6.1 创建管理员端统计Controller
- [ ] 创建 `controller/admin/AdminStatisticsController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/admin/statistics")
  @RequireRole("admin")
  ```

- [ ] 实现GET /api/admin/statistics/dashboard接口（控制台数据）
- [ ] 实现GET /api/admin/statistics/users接口（用户统计）
- [ ] 实现GET /api/admin/statistics/courses接口（课程统计）
- [ ] 实现GET /api/admin/statistics/enrollments接口（选课统计）
- [ ] 实现GET /api/admin/statistics/revenue接口（收入统计）
- [ ] 实现POST /api/admin/statistics/export接口（导出报表）

### 6.2 创建教师端统计Controller
- [ ] 创建 `controller/teacher/TeacherStatisticsController.java`
- [ ] 实现GET /api/teacher/statistics/courses接口（我的课程统计）
- [ ] 实现GET /api/teacher/statistics/students接口（学员统计）

### 6.3 创建学生端统计Controller
- [ ] 创建 `controller/student/StudentStatisticsController.java`
- [ ] 实现GET /api/student/statistics/overview接口（学习概览）
- [ ] 实现GET /api/student/statistics/progress接口（学习进度）
- [ ] 实现GET /api/student/statistics/calendar接口（学习日历）

---

## 七、图表数据格式化

### 7.1 创建图表工具类
- [ ] 创建 `util/ChartUtil.java`
  ```java
  public class ChartUtil {
    // 格式化折线图数据
    public static Map<String, Object> formatLineChart(
      List<String> labels,
      List<Integer> data
    ) {
      Map<String, Object> result = new HashMap<>();
      result.put("labels", labels);
      result.put("data", data);
      return result;
    }
    
    // 格式化饼图数据
    public static List<Map<String, Object>> formatPieChart(
      Map<String, Integer> data
    ) {
      List<Map<String, Object>> result = new ArrayList<>();
      for (Map.Entry<String, Integer> entry : data.entrySet()) {
        Map<String, Object> item = new HashMap<>();
        item.put("name", entry.getKey());
        item.put("value", entry.getValue());
        result.add(item);
      }
      return result;
    }
  }
  ```

---

## 八、测试

### 8.1 单元测试
- [ ] 测试StatisticsMapper的聚合查询
- [ ] 测试StatisticsService的数据计算
- [ ] 测试报表导出功能

### 8.2 接口测试
- [ ] 测试控制台数据接口
- [ ] 测试各类统计接口
- [ ] 测试报表导出

### 8.3 性能测试
- [ ] 测试大数据量查询性能
- [ ] 测试缓存效果

---

## 九、文档更新

### 9.1 Swagger文档
- [ ] 为所有接口添加@Operation注解

### 9.2 接口文档
- [ ] 编写数据统计接口文档
- [ ] 说明统计指标含义

---

## 十、Git提交

### 10.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成数据统计模块"
- [ ] git push

---

## 验收标准

- ✅ 管理员能查看控制台数据
- ✅ 管理员能查看各类统计报表
- ✅ 管理员能导出Excel报表
- ✅ 教师能查看课程统计
- ✅ 学生能查看学习统计
- ✅ 统计数据准确
- ✅ 缓存机制生效
- ✅ 所有接口测试通过

---

## 预计耗时

- **总计：4-5天**
  - Mapper层SQL编写：1.5天
  - Service层实现：1.5天
  - Controller层：0.5天
  - 报表导出：0.5天
  - 测试和文档：1天

---

## 下一步

完成本模块后，进入 **模块12：系统管理模块**
# 模块12：系统管理模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块02（安全与认证模块）已完成

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V10__create_system_tables.sql`
- [ ] 编写system_notice表创建SQL
  ```sql
  CREATE TABLE system_notice (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    notice_title VARCHAR(200) NOT NULL COMMENT '公告标题',
    notice_content TEXT NOT NULL COMMENT '公告内容',
    notice_type TINYINT DEFAULT 1 COMMENT '公告类型：1-系统通知，2-活动公告，3-维护通知',
    priority TINYINT DEFAULT 1 COMMENT '优先级：1-普通，2-重要，3-紧急',
    target_role VARCHAR(50) COMMENT '目标角色（逗号分隔）',
    is_top TINYINT DEFAULT 0 COMMENT '是否置顶',
    publish_time DATETIME COMMENT '发布时间',
    expire_time DATETIME COMMENT '过期时间',
    status TINYINT DEFAULT 0 COMMENT '状态：0-草稿，1-已发布，2-已过期',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_status (status),
    KEY idx_publish_time (publish_time)
  ) COMMENT='系统公告表';
  ```

- [ ] 编写operation_log表创建SQL
  ```sql
  CREATE TABLE operation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '操作人ID',
    username VARCHAR(50) COMMENT '操作人用户名',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    operation_desc VARCHAR(200) COMMENT '操作描述',
    request_method VARCHAR(10) COMMENT '请求方法',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_params TEXT COMMENT '请求参数',
    response_result TEXT COMMENT '响应结果',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent VARCHAR(500) COMMENT 'User-Agent',
    execute_time INT COMMENT '执行时长(ms)',
    status TINYINT DEFAULT 1 COMMENT '状态：1-成功，0-失败',
    error_message TEXT COMMENT '错误信息',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_operation_type (operation_type),
    KEY idx_create_time (create_time)
  ) COMMENT='操作日志表';
  ```

- [ ] 编写system_config表创建SQL
  ```sql
  CREATE TABLE system_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    config_desc VARCHAR(200) COMMENT '配置描述',
    config_type VARCHAR(20) DEFAULT 'string' COMMENT '配置类型：string, number, boolean, json',
    is_public TINYINT DEFAULT 0 COMMENT '是否公开',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_config_key (config_key)
  ) COMMENT='系统配置表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建
- [ ] 插入初始系统配置

---

## 二、实体类创建

### 2.1 创建系统实体
- [ ] 创建 `entity/SystemNotice.java`
- [ ] 创建 `entity/OperationLog.java`
- [ ] 创建 `entity/SystemConfig.java`

---

## 三、DTO类创建

### 3.1 公告DTO
- [ ] 创建 `dto/request/NoticeCreateRequest.java`
  ```java
  - noticeTitle: String (@NotBlank)
  - noticeContent: String (@NotBlank)
  - noticeType: Integer (@NotNull)
  - priority: Integer
  - targetRole: String
  - publishTime: LocalDateTime
  - expireTime: LocalDateTime
  ```

- [ ] 创建 `dto/request/NoticeUpdateRequest.java`
- [ ] 创建 `dto/request/NoticeQueryRequest.java`

### 3.2 日志DTO
- [ ] 创建 `dto/request/LogQueryRequest.java`
  ```java
  - userId: Long
  - operationType: String
  - status: Integer
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - pageNum: Integer
  - pageSize: Integer
  ```

### 3.3 配置DTO
- [ ] 创建 `dto/request/ConfigUpdateRequest.java`
  ```java
  - configKey: String (@NotBlank)
  - configValue: String (@NotBlank)
  ```

### 3.4 响应VO
- [ ] 创建 `vo/NoticeVO.java`
- [ ] 创建 `vo/LogVO.java`
- [ ] 创建 `vo/ConfigVO.java`

---

## 四、Mapper层实现

### 4.1 创建SystemNoticeMapper
- [ ] 创建 `mapper/SystemNoticeMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(SystemNotice notice)
  - updateById(SystemNotice notice)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCondition(NoticeQueryRequest request)
  - selectActiveNotices(String targetRole)
  - updateStatus(Long id, Integer status)
  ```

- [ ] 创建 `resources/mapper/SystemNoticeMapper.xml`

### 4.2 创建OperationLogMapper
- [ ] 创建 `mapper/OperationLogMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(OperationLog log)
  - selectById(Long id)
  - selectByCondition(LogQueryRequest request)
  - deleteById(Long id)
  - deleteBefore(LocalDateTime date)
  ```

- [ ] 创建 `resources/mapper/OperationLogMapper.xml`

### 4.3 创建SystemConfigMapper
- [ ] 创建 `mapper/SystemConfigMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(SystemConfig config)
  - updateById(SystemConfig config)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByKey(String key)
  - selectAll()
  - selectPublicConfigs()
  ```

- [ ] 创建 `resources/mapper/SystemConfigMapper.xml`

---

## 五、Service层实现

### 5.1 创建SystemNoticeService
- [ ] 创建 `service/ISystemNoticeService.java`
- [ ] 定义方法：
  ```java
  - PageResult<NoticeVO> getNoticeList(NoticeQueryRequest request)
  - NoticeVO getNoticeById(Long id)
  - Long createNotice(NoticeCreateRequest request)
  - void updateNotice(Long id, NoticeUpdateRequest request)
  - void deleteNotice(Long id)
  - void publishNotice(Long id)
  - List<NoticeVO> getActiveNotices(String targetRole)
  ```

- [ ] 创建 `service/impl/SystemNoticeServiceImpl.java`
- [ ] 实现publishNotice方法：
  ```java
  @Override
  public void publishNotice(Long id) {
    SystemNotice notice = systemNoticeMapper.selectById(id);
    if (notice == null) {
      throw new BusinessException(ErrorCode.NOT_FOUND, "公告不存在");
    }
    
    notice.setStatus(1);
    notice.setPublishTime(LocalDateTime.now());
    systemNoticeMapper.updateById(notice);
    
    log.info("公告已发布：{}", id);
  }
  ```

### 5.2 创建OperationLogService
- [ ] 创建 `service/IOperationLogService.java`
- [ ] 定义方法：
  ```java
  - void saveLog(OperationLog log)
  - PageResult<LogVO> getLogList(LogQueryRequest request)
  - LogVO getLogById(Long id)
  - void deleteLog(Long id)
  - void clearLogs(LocalDateTime beforeDate)
  ```

- [ ] 创建 `service/impl/OperationLogServiceImpl.java`
- [ ] 实现saveLog方法（异步）：
  ```java
  @Override
  @Async
  public void saveLog(OperationLog log) {
    try {
      operationLogMapper.insert(log);
    } catch (Exception e) {
      log.error("保存操作日志失败", e);
    }
  }
  ```

### 5.3 创建SystemConfigService
- [ ] 创建 `service/ISystemConfigService.java`
- [ ] 定义方法：
  ```java
  - String getConfig(String key)
  - void updateConfig(String key, String value)
  - Map<String, String> getAllConfigs()
  - Map<String, String> getPublicConfigs()
  ```

- [ ] 创建 `service/impl/SystemConfigServiceImpl.java`
- [ ] 实现getConfig方法（带缓存）：
  ```java
  @Override
  @Cacheable(value = "system:config", key = "#key")
  public String getConfig(String key) {
    SystemConfig config = systemConfigMapper.selectByKey(key);
    return config != null ? config.getConfigValue() : null;
  }
  
  @Override
  @CacheEvict(value = "system:config", key = "#key")
  public void updateConfig(String key, String value) {
    SystemConfig config = systemConfigMapper.selectByKey(key);
    if (config == null) {
      throw new BusinessException(ErrorCode.NOT_FOUND, "配置不存在");
    }
    
    config.setConfigValue(value);
    systemConfigMapper.updateById(config);
    
    log.info("系统配置已更新：{} = {}", key, value);
  }
  ```

---

## 六、日志切面

### 6.1 创建日志注解
- [ ] 创建 `common/annotation/OperationLog.java`
  ```java
  @Target(ElementType.METHOD)
  @Retention(RetentionPolicy.RUNTIME)
  public @interface OperationLog {
    String value() default ""; // 操作描述
    String type() default ""; // 操作类型
  }
  ```

### 6.2 创建日志切面
- [ ] 创建 `aspect/LogAspect.java`
  ```java
  @Aspect
  @Component
  public class LogAspect {
    @Autowired
    private IOperationLogService operationLogService;
    
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) throws Throwable {
      long startTime = System.currentTimeMillis();
      
      // 获取请求信息
      ServletRequestAttributes attributes = 
        (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
      HttpServletRequest request = attributes.getRequest();
      
      // 构建日志对象
      com.ittraining.entity.OperationLog log = new com.ittraining.entity.OperationLog();
      
      // 获取当前用户
      try {
        Long userId = SecurityUtils.getCurrentUserId();
        String username = SecurityUtils.getCurrentUsername();
        log.setUserId(userId);
        log.setUsername(username);
      } catch (Exception e) {
        // 未登录
      }
      
      log.setOperationType(operationLog.type());
      log.setOperationDesc(operationLog.value());
      log.setRequestMethod(request.getMethod());
      log.setRequestUrl(request.getRequestURI());
      log.setIpAddress(getIpAddress(request));
      log.setUserAgent(request.getHeader("User-Agent"));
      
      // 获取请求参数
      Object[] args = point.getArgs();
      if (args.length > 0) {
        log.setRequestParams(JSON.toJSONString(args));
      }
      
      Object result = null;
      try {
        // 执行方法
        result = point.proceed();
        
        log.setStatus(1);
        log.setResponseResult(JSON.toJSONString(result));
      } catch (Exception e) {
        log.setStatus(0);
        log.setErrorMessage(e.getMessage());
        throw e;
      } finally {
        long executeTime = System.currentTimeMillis() - startTime;
        log.setExecuteTime((int) executeTime);
        
        // 异步保存日志
        operationLogService.saveLog(log);
      }
      
      return result;
    }
    
    private String getIpAddress(HttpServletRequest request) {
      String ip = request.getHeader("X-Forwarded-For");
      if (ip == null || ip.isEmpty()) {
        ip = request.getRemoteAddr();
      }
      return ip;
    }
  }
  ```

---

## 七、定时任务

### 7.1 创建公告过期任务
- [ ] 创建 `task/NoticeExpireTask.java`
  ```java
  @Component
  public class NoticeExpireTask {
    @Autowired
    private SystemNoticeMapper systemNoticeMapper;
    
    @Scheduled(cron = "0 0 * * * ?") // 每小时
    public void expireNotices() {
      // 查询已过期的公告
      List<SystemNotice> notices = systemNoticeMapper.selectExpiredNotices();
      
      for (SystemNotice notice : notices) {
        notice.setStatus(2); // 已过期
        systemNoticeMapper.updateById(notice);
      }
      
      log.info("已处理{}条过期公告", notices.size());
    }
  }
  ```

### 7.2 创建日志清理任务
- [ ] 创建 `task/LogCleanTask.java`
  ```java
  @Component
  public class LogCleanTask {
    @Autowired
    private IOperationLogService operationLogService;
    
    @Scheduled(cron = "0 0 2 * * ?") // 每天凌晨2点
    public void cleanOldLogs() {
      // 删除90天前的日志
      LocalDateTime beforeDate = LocalDateTime.now().minusDays(90);
      operationLogService.clearLogs(beforeDate);
      
      log.info("已清理90天前的操作日志");
    }
  }
  ```

---

## 八、Controller层实现

### 8.1 创建系统管理Controller
- [ ] 创建 `controller/admin/AdminSystemController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/admin/system")
  @RequireRole("admin")
  ```

- [ ] 实现GET /api/admin/system/notices接口（公告列表）
- [ ] 实现POST /api/admin/system/notices接口（创建公告）
- [ ] 实现PUT /api/admin/system/notices/{id}接口（更新公告）
- [ ] 实现DELETE /api/admin/system/notices/{id}接口（删除公告）
- [ ] 实现PUT /api/admin/system/notices/{id}/publish接口（发布公告）
- [ ] 实现GET /api/admin/system/logs接口（操作日志列表）
- [ ] 实现GET /api/admin/system/config接口（系统配置）
- [ ] 实现PUT /api/admin/system/config接口（更新配置）

### 8.2 创建公共公告Controller
- [ ] 创建 `controller/NoticeController.java`
- [ ] 实现GET /api/notices接口（公告列表-学生端）
- [ ] 实现GET /api/notices/{id}接口（公告详情）

---

## 九、测试

### 9.1 单元测试
- [ ] 测试SystemNoticeMapper的CRUD方法
- [ ] 测试OperationLogService的异步保存
- [ ] 测试SystemConfigService的缓存

### 9.2 接口测试
- [ ] 测试公告管理
- [ ] 测试日志查询
- [ ] 测试系统配置

### 9.3 切面测试
- [ ] 测试日志切面是否正常记录

---

## 十、文档更新

### 10.1 Swagger文档
- [ ] 为所有接口添加@Operation注解

### 10.2 接口文档
- [ ] 编写系统管理接口文档

---

## 十一、Git提交

### 11.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成系统管理模块"
- [ ] git push

---

## 验收标准

- ✅ 管理员能创建和管理公告
- ✅ 管理员能查看操作日志
- ✅ 管理员能管理系统配置
- ✅ 用户能查看公告
- ✅ 日志切面正常工作
- ✅ 定时任务正常执行
- ✅ 所有接口测试通过

---

## 预计耗时

- **总计：3-4天**
  - 数据库和实体类：0.5天
  - Mapper和Service层：1天
  - 日志切面：0.5天
  - Controller层：0.5天
  - 测试和文档：1天

---

## 下一步

完成本模块后，进入 **模块13：集成与测试**
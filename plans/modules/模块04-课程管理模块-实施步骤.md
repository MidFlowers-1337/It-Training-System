# 模块04：课程管理模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块02（安全与认证模块）已完成
- ✅ 模块03（用户管理模块）已完成
- ✅ 数据库连接已配置

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V3__create_course_tables.sql`
- [ ] 编写course表创建SQL
  ```sql
  - 基本信息: id, course_name, course_code, category_id, teacher_id
  - 描述信息: cover_image, description, difficulty_level, duration
  - 价格信息: price, original_price
  - 名额信息: max_students, enrolled_count, stock, version(乐观锁)
  - 统计信息: view_count, rating, rating_count
  - 状态信息: status, is_hot, is_recommend
  - 时间信息: start_time, end_time, create_time, update_time
  ```

- [ ] 编写course_category表创建SQL
  ```sql
  - id, category_name, parent_id, sort_order
  - icon, description, status
  - create_time, update_time
  ```

- [ ] 编写course_chapter表创建SQL
  ```sql
  - id, course_id, chapter_name, chapter_order
  - duration, is_free, status
  - create_time, update_time
  ```

- [ ] 编写course_resource表创建SQL
  ```sql
  - id, chapter_id, resource_name, resource_type
  - resource_url, resource_size, duration
  - sort_order, status
  - create_time, update_time
  ```

- [ ] 编写course_tag表创建SQL
  ```sql
  - id, tag_name, tag_color, use_count
  - create_time, update_time
  ```

- [ ] 编写course_tag_relation表创建SQL
  ```sql
  - id, course_id, tag_id
  - create_time
  ```

- [ ] 编写course_review表创建SQL
  ```sql
  - id, course_id, student_id, rating, review_content
  - like_count, status
  - create_time, update_time
  ```

- [ ] 添加必要的索引
  ```sql
  - course表: idx_category_id, idx_teacher_id, idx_status
  - course_chapter表: idx_course_id
  - course_resource表: idx_chapter_id
  - course_tag_relation表: idx_course_id, idx_tag_id
  - course_review表: idx_course_id, idx_student_id
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证所有表已创建
- [ ] 插入初始分类数据

---

## 二、实体类创建

### 2.1 创建Course实体
- [ ] 创建 `entity/Course.java`
- [ ] 定义所有字段（参考数据库表）
- [ ] 添加@Table和@Column注解
- [ ] 添加@Data注解（Lombok）
- [ ] 添加必要的校验注解

### 2.2 创建CourseCategory实体
- [ ] 创建 `entity/CourseCategory.java`
- [ ] 定义字段
- [ ] 添加注解

### 2.3 创建CourseChapter实体
- [ ] 创建 `entity/CourseChapter.java`
- [ ] 定义字段
- [ ] 添加注解

### 2.4 创建CourseResource实体
- [ ] 创建 `entity/CourseResource.java`
- [ ] 定义字段
- [ ] 添加注解

### 2.5 创建CourseTag实体
- [ ] 创建 `entity/CourseTag.java`
- [ ] 定义字段
- [ ] 添加注解

### 2.6 创建CourseTagRelation实体
- [ ] 创建 `entity/CourseTagRelation.java`
- [ ] 定义字段
- [ ] 添加注解

### 2.7 创建CourseReview实体
- [ ] 创建 `entity/CourseReview.java`
- [ ] 定义字段
- [ ] 添加注解

---

## 三、DTO类创建

### 3.1 课程查询DTO
- [ ] 创建 `dto/request/CourseQueryRequest.java`
  ```java
  - keyword: String (课程名称/编号模糊查询)
  - categoryId: Long (分类ID)
  - teacherId: Long (教师ID)
  - difficultyLevel: Integer (难度等级)
  - minPrice: BigDecimal (最低价格)
  - maxPrice: BigDecimal (最高价格)
  - status: Integer (状态)
  - isHot: Boolean (是否热门)
  - isRecommend: Boolean (是否推荐)
  - sortBy: String (排序字段: create_time, view_count, rating, price)
  - sortOrder: String (排序方向: asc, desc)
  - pageNum: Integer
  - pageSize: Integer
  ```

### 3.2 课程创建/更新DTO
- [ ] 创建 `dto/request/CourseCreateRequest.java`
  ```java
  - courseName: String (@NotBlank)
  - courseCode: String (@NotBlank)
  - categoryId: Long (@NotNull)
  - coverImage: String
  - description: String
  - difficultyLevel: Integer
  - duration: Integer
  - price: BigDecimal (@NotNull)
  - originalPrice: BigDecimal
  - maxStudents: Integer (@NotNull)
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - tagIds: List<Long> (标签ID列表)
  ```

- [ ] 创建 `dto/request/CourseUpdateRequest.java`
  ```java
  - 同CourseCreateRequest，但所有字段可选
  ```

### 3.3 章节DTO
- [ ] 创建 `dto/request/ChapterCreateRequest.java`
  ```java
  - courseId: Long (@NotNull)
  - chapterName: String (@NotBlank)
  - chapterOrder: Integer
  - duration: Integer
  - isFree: Boolean
  ```

- [ ] 创建 `dto/request/ChapterUpdateRequest.java`

### 3.4 资源DTO
- [ ] 创建 `dto/request/ResourceUploadRequest.java`
  ```java
  - chapterId: Long (@NotNull)
  - resourceName: String (@NotBlank)
  - resourceType: String (video, document, code)
  - file: MultipartFile
  ```

### 3.5 评价DTO
- [ ] 创建 `dto/request/ReviewCreateRequest.java`
  ```java
  - courseId: Long (@NotNull)
  - rating: Integer (@Min(1), @Max(5))
  - reviewContent: String (@NotBlank)
  ```

### 3.6 响应VO
- [ ] 创建 `vo/CourseVO.java`
  ```java
  - 课程基本信息
  - 分类信息: CategoryVO
  - 教师信息: TeacherVO
  - 标签列表: List<TagVO>
  - 不包含敏感信息
  ```

- [ ] 创建 `vo/CourseDetailVO.java`
  ```java
  - 继承CourseVO
  - 章节列表: List<ChapterVO>
  - 评价统计: ReviewStatisticsVO
  - 是否已选课: Boolean
  ```

- [ ] 创建 `vo/ChapterVO.java`
  ```java
  - 章节信息
  - 资源列表: List<ResourceVO>
  ```

- [ ] 创建 `vo/CategoryVO.java`
- [ ] 创建 `vo/TagVO.java`
- [ ] 创建 `vo/ReviewVO.java`

---

## 四、Mapper层实现

### 4.1 创建CourseMapper
- [ ] 创建 `mapper/CourseMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(Course course)
  - updateById(Course course)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCondition(CourseQueryRequest request)
  - incrementViewCount(Long id)
  - incrementEnrolledCount(Long id)
  - decrementStock(Long id, Integer version) - 乐观锁扣减
  - updateRating(Long id, BigDecimal rating, Integer count)
  - selectHotCourses(Integer limit)
  - selectRecommendCourses(Integer limit)
  ```

- [ ] 创建 `resources/mapper/CourseMapper.xml`
- [ ] 编写SQL语句：
  ```xml
  - 基础CRUD
  - 动态条件查询（使用<where>和<if>标签）
  - 多表关联查询（课程+分类+教师）
  - 乐观锁更新（WHERE version = #{version}）
  - 统计查询
  ```

### 4.2 创建CourseCategoryMapper
- [ ] 创建 `mapper/CourseCategoryMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(CourseCategory category)
  - updateById(CourseCategory category)
  - deleteById(Long id)
  - selectById(Long id)
  - selectAll()
  - selectByParentId(Long parentId)
  - selectTree() - 查询分类树
  ```

- [ ] 创建 `resources/mapper/CourseCategoryMapper.xml`
- [ ] 编写SQL（包括递归查询分类树）

### 4.3 创建CourseChapterMapper
- [ ] 创建 `mapper/CourseChapterMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(CourseChapter chapter)
  - updateById(CourseChapter chapter)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCourseId(Long courseId)
  - updateOrder(Long id, Integer order)
  - batchUpdateOrder(List<CourseChapter> chapters)
  ```

- [ ] 创建 `resources/mapper/CourseChapterMapper.xml`

### 4.4 创建CourseResourceMapper
- [ ] 创建 `mapper/CourseResourceMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(CourseResource resource)
  - updateById(CourseResource resource)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByChapterId(Long chapterId)
  - selectByCourseId(Long courseId)
  ```

- [ ] 创建 `resources/mapper/CourseResourceMapper.xml`

### 4.5 创建CourseTagMapper
- [ ] 创建 `mapper/CourseTagMapper.java` 接口
- [ ] 创建 `resources/mapper/CourseTagMapper.xml`

### 4.6 创建CourseTagRelationMapper
- [ ] 创建 `mapper/CourseTagRelationMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insertBatch(List<CourseTagRelation> relations)
  - deleteByCourseId(Long courseId)
  - selectTagsByCourseId(Long courseId)
  - selectCoursesByTagId(Long tagId)
  ```

- [ ] 创建 `resources/mapper/CourseTagRelationMapper.xml`

### 4.7 创建CourseReviewMapper
- [ ] 创建 `mapper/CourseReviewMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(CourseReview review)
  - updateById(CourseReview review)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCourseId(Long courseId, PageHelper)
  - selectByStudentAndCourse(Long studentId, Long courseId)
  - incrementLikeCount(Long id)
  - calculateAverageRating(Long courseId)
  ```

- [ ] 创建 `resources/mapper/CourseReviewMapper.xml`

---

## 五、Service层实现

### 5.1 创建CourseService接口
- [ ] 创建 `service/ICourseService.java`
- [ ] 定义方法：
  ```java
  - PageResult<CourseVO> getCourseList(CourseQueryRequest request)
  - CourseDetailVO getCourseDetail(Long id)
  - Long createCourse(CourseCreateRequest request)
  - void updateCourse(Long id, CourseUpdateRequest request)
  - void deleteCourse(Long id)
  - void publishCourse(Long id)
  - void unpublishCourse(Long id)
  - void incrementViewCount(Long id)
  - List<CourseVO> getHotCourses(Integer limit)
  - List<CourseVO> getRecommendCourses(Integer limit)
  - List<CourseVO> getMyCourses(Long teacherId)
  ```

### 5.2 实现CourseService
- [ ] 创建 `service/impl/CourseServiceImpl.java`
- [ ] 实现getCourseList方法：
  ```java
  - 使用PageHelper分页
  - 调用courseMapper.selectByCondition()
  - 查询每个课程的分类、教师、标签信息
  - 转换为CourseVO
  - 返回PageResult
  ```

- [ ] 实现getCourseDetail方法：
  ```java
  - 查询课程基本信息
  - 查询分类信息
  - 查询教师信息
  - 查询章节列表（包含资源）
  - 查询标签列表
  - 查询评价统计
  - 检查当前用户是否已选课
  - 组装CourseDetailVO
  ```

- [ ] 实现createCourse方法：
  ```java
  - 检查课程编号唯一性
  - 检查分类是否存在
  - 获取当前教师ID
  - 设置初始值（stock=maxStudents, enrolledCount=0）
  - 插入课程
  - 保存课程标签关联
  - 返回课程ID
  ```

- [ ] 实现updateCourse方法：
  ```java
  - 检查课程是否存在
  - 检查权限（只能修改自己的课程）
  - 更新课程信息
  - 更新标签关联（先删除后插入）
  ```

- [ ] 实现deleteCourse方法：
  ```java
  - 检查课程是否存在
  - 检查权限
  - 检查是否有学员选课（有则不能删除）
  - 软删除课程
  - 删除标签关联
  ```

- [ ] 实现publishCourse方法：
  ```java
  - 检查课程是否存在
  - 检查权限
  - 检查课程信息完整性（章节、资源）
  - 更新状态为已发布
  ```

- [ ] 实现incrementViewCount方法：
  ```java
  - Redis计数器增加
  - 异步更新数据库（定时任务）
  ```

- [ ] 实现getHotCourses方法：
  ```java
  - 从Redis缓存获取
  - 缓存未命中则查询数据库
  - 按浏览量或选课人数排序
  - 缓存结果（1小时）
  ```

### 5.3 创建CourseCategoryService
- [ ] 创建 `service/ICourseCategoryService.java`
- [ ] 定义方法：
  ```java
  - List<CategoryVO> getCategoryTree()
  - CategoryVO getCategoryById(Long id)
  - Long createCategory(CategoryCreateRequest request)
  - void updateCategory(Long id, CategoryUpdateRequest request)
  - void deleteCategory(Long id)
  ```

- [ ] 创建 `service/impl/CourseCategoryServiceImpl.java`
- [ ] 实现getCategoryTree方法：
  ```java
  - 查询所有分类
  - 构建树形结构（递归或迭代）
  - 缓存结果
  ```

- [ ] 实现deleteCategory方法：
  ```java
  - 检查是否有子分类
  - 检查是否有课程使用
  - 删除分类
  ```

### 5.4 创建CourseChapterService
- [ ] 创建 `service/ICourseChapterService.java`
- [ ] 定义方法：
  ```java
  - List<ChapterVO> getChaptersByCourseId(Long courseId)
  - ChapterVO getChapterById(Long id)
  - Long createChapter(ChapterCreateRequest request)
  - void updateChapter(Long id, ChapterUpdateRequest request)
  - void deleteChapter(Long id)
  - void sortChapters(Long courseId, List<Long> chapterIds)
  ```

- [ ] 创建 `service/impl/CourseChapterServiceImpl.java`
- [ ] 实现sortChapters方法：
  ```java
  - 检查章节是否属于该课程
  - 批量更新章节顺序
  ```

### 5.5 创建CourseResourceService
- [ ] 创建 `service/ICourseResourceService.java`
- [ ] 定义方法：
  ```java
  - List<ResourceVO> getResourcesByChapterId(Long chapterId)
  - Long uploadResource(ResourceUploadRequest request)
  - void deleteResource(Long id)
  - String getResourceUrl(Long id) - 生成临时访问URL
  ```

- [ ] 创建 `service/impl/CourseResourceServiceImpl.java`
- [ ] 实现uploadResource方法：
  ```java
  - 验证文件类型和大小
  - 上传文件到存储（本地/OSS）
  - 保存资源记录
  - 返回资源ID
  ```

- [ ] 实现getResourceUrl方法：
  ```java
  - 检查用户是否有权限访问
  - 生成临时访问URL（有效期1小时）
  - 返回URL
  ```

### 5.6 创建CourseReviewService
- [ ] 创建 `service/ICourseReviewService.java`
- [ ] 定义方法：
  ```java
  - PageResult<ReviewVO> getReviewList(Long courseId, Integer pageNum, Integer pageSize)
  - Long createReview(ReviewCreateRequest request)
  - void deleteReview(Long id)
  - void likeReview(Long id)
  ```

- [ ] 创建 `service/impl/CourseReviewServiceImpl.java`
- [ ] 实现createReview方法：
  ```java
  - 检查是否已选课
  - 检查是否已评价
  - 创建评价
  - 更新课程评分（重新计算平均分）
  ```

- [ ] 实现likeReview方法：
  ```java
  - 检查是否已点赞（Redis记录）
  - 增加点赞数
  - 记录点赞关系
  ```

---

## 六、Controller层实现

### 6.1 创建学生端Controller
- [ ] 创建 `controller/CourseController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/courses")
  ```

- [ ] 实现GET /api/courses接口（课程列表）
- [ ] 实现GET /api/courses/{id}接口（课程详情）
- [ ] 实现GET /api/courses/hot接口（热门课程）
- [ ] 实现GET /api/courses/recommend接口（推荐课程）
- [ ] 实现POST /api/courses/{id}/view接口（增加浏览量）
- [ ] 实现GET /api/courses/{id}/reviews接口（评价列表）
- [ ] 实现POST /api/courses/{id}/reviews接口（发表评价）

### 6.2 创建教师端Controller
- [ ] 创建 `controller/teacher/TeacherCourseController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/teacher/courses")
  @RequireRole("teacher")
  ```

- [ ] 实现GET /api/teacher/courses接口（我的课程列表）
- [ ] 实现POST /api/teacher/courses接口（创建课程）
- [ ] 实现PUT /api/teacher/courses/{id}接口（更新课程）
- [ ] 实现DELETE /api/teacher/courses/{id}接口（删除课程）
- [ ] 实现PUT /api/teacher/courses/{id}/publish接口（发布课程）
- [ ] 实现POST /api/teacher/courses/{id}/chapters接口（添加章节）
- [ ] 实现POST /api/teacher/courses/{id}/resources接口（上传资源）

### 6.3 创建管理员端Controller
- [ ] 创建 `controller/admin/AdminCourseController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/admin/courses")
  @RequireRole("admin")
  ```

- [ ] 实现GET /api/admin/courses接口（所有课程列表）
- [ ] 实现PUT /api/admin/courses/{id}/audit接口（审核课程）
- [ ] 实现PUT /api/admin/courses/{id}/status接口（上下架）
- [ ] 实现PUT /api/admin/courses/{id}/hot接口（设置热门）
- [ ] 实现PUT /api/admin/courses/{id}/recommend接口（设置推荐）

### 6.4 创建分类管理Controller
- [ ] 创建 `controller/admin/AdminCategoryController.java`
- [ ] 实现分类CRUD接口

---

## 七、定时任务

### 7.1 创建浏览量同步任务
- [ ] 创建 `task/CourseViewSyncTask.java`
- [ ] 添加@Scheduled注解
  ```java
  @Scheduled(cron = "0 */5 * * * ?") // 每5分钟
  public void syncViewCount() {
    // 从Redis获取所有课程浏览量
    // 批量更新到数据库
    // 清空Redis计数器
  }
  ```

### 7.2 创建热门课程缓存刷新任务
- [ ] 创建 `task/HotCourseCacheTask.java`
- [ ] 添加@Scheduled注解
  ```java
  @Scheduled(cron = "0 0 */1 * * ?") // 每小时
  public void refreshHotCourses() {
    // 查询热门课程
    // 更新Redis缓存
  }
  ```

---

## 八、测试

### 8.1 单元测试
- [ ] 测试CourseMapper的动态查询
- [ ] 测试CourseService的createCourse方法
- [ ] 测试CourseService的乐观锁扣减
- [ ] 测试CourseCategoryService的树形结构构建
- [ ] 测试CourseReviewService的评分计算

### 8.2 接口测试
- [ ] 测试课程列表（分页、搜索、筛选、排序）
- [ ] 测试课程详情
- [ ] 测试创建课程（正常、参数错误）
- [ ] 测试更新课程
- [ ] 测试删除课程（有学员、无学员）
- [ ] 测试发布课程（信息不完整、正常）
- [ ] 测试章节管理
- [ ] 测试资源上传
- [ ] 测试评价功能

### 8.3 权限测试
- [ ] 测试教师只能管理自己的课程
- [ ] 测试学生不能访问教师接口
- [ ] 测试管理员权限

---

## 九、文档更新

### 9.1 Swagger文档
- [ ] 为所有接口添加@Operation注解
- [ ] 添加请求/响应示例
- [ ] 添加错误码说明

### 9.2 接口文档
- [ ] 编写课程管理接口文档
- [ ] 说明文件上传规范
- [ ] 说明评分计算规则

---

## 十、Git提交

### 10.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成课程管理模块"
  ```
  - 实现课程CRUD功能
  - 实现分类管理功能
  - 实现章节和资源管理
  - 实现评价功能
  - 实现热门课程推荐
  - 添加浏览量统计
  ```
- [ ] git push

---

## 验收标准

- ✅ 学生能浏览课程列表（分页、搜索、筛选、排序）
- ✅ 学生能查看课程详情（章节、资源、评价）
- ✅ 学生能查看热门和推荐课程
- ✅ 学生能发表课程评价
- ✅ 教师能创建、编辑、删除自己的课程
- ✅ 教师能管理课程章节和资源
- ✅ 教师能发布课程
- ✅ 管理员能审核课程
- ✅ 管理员能设置热门和推荐
- ✅ 分类管理功能正常
- ✅ 浏览量统计正常
- ✅ 评分计算正确
- ✅ 所有接口测试通过
- ✅ 单元测试覆盖率>80%
- ✅ Swagger文档完整

---

## 预计耗时

- **总计：7-10天**
  - 数据库和实体类：1天
  - Mapper层实现：1.5天
  - Service层实现：2.5天
  - Controller层实现：1.5天
  - 测试和调试：1.5天
  - 文档编写：0.5天

---

## 下一步

完成本模块后，进入 **模块05：选课管理模块（高并发核心）**
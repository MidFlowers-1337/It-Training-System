# 模块13：集成与测试 - 实施步骤

## 前置条件

- ✅ 所有业务模块（模块01-12）已完成
- ✅ 所有功能已开发完毕

---

## 一、单元测试

### 1.1 Service层单元测试
- [ ] 为所有Service类编写单元测试
  ```java
  @SpringBootTest
  @RunWith(SpringRunner.class)
  public class UserServiceTest {
    @Autowired
    private IUserService userService;
    
    @MockBean
    private UserMapper userMapper;
    
    @Test
    public void testCreateUser() {
      // 测试正常创建
      // 测试用户名重复
      // 测试参数校验
    }
  }
  ```

- [ ] 使用Mockito模拟依赖
- [ ] 测试业务逻辑正确性
- [ ] 测试异常处理
- [ ] 测试边界条件
- [ ] 目标：单元测试覆盖率 > 80%

### 1.2 Mapper层测试
- [ ] 为所有Mapper编写测试
  ```java
  @MybatisTest
  @AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
  public class UserMapperTest {
    @Autowired
    private UserMapper userMapper;
    
    @Test
    public void testSelectByUsername() {
      // 测试SQL正确性
    }
  }
  ```

- [ ] 测试SQL正确性
- [ ] 测试复杂查询
- [ ] 测试动态SQL

### 1.3 工具类测试
- [ ] 测试JwtUtil
- [ ] 测试PasswordUtil
- [ ] 测试RedisUtil
- [ ] 测试FileUtil
- [ ] 测试所有自定义工具类

---

## 二、接口测试

### 2.1 Controller层集成测试
- [ ] 使用MockMvc测试所有接口
  ```java
  @SpringBootTest
  @AutoConfigureMockMvc
  public class UserControllerTest {
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    public void testGetUserList() throws Exception {
      mockMvc.perform(get("/api/admin/users")
        .header("Authorization", "Bearer " + token))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.code").value(200));
    }
  }
  ```

- [ ] 测试HTTP请求响应
- [ ] 测试参数校验
- [ ] 测试权限控制
- [ ] 测试异常处理

### 2.2 使用Postman/Apifox测试
- [ ] 创建测试集合
- [ ] 测试所有接口
- [ ] 测试正常流程
- [ ] 测试异常流程
- [ ] 导出测试用例

---

## 三、高并发测试

### 3.1 选课接口压力测试
- [ ] 使用JMeter创建测试计划
  ```
  测试场景1：1000人抢100个名额
  - 线程数：1000
  - Ramp-Up时间：10秒
  - 循环次数：1
  - 目标接口：POST /api/enrollments
  ```

- [ ] 测试场景2：同一用户重复选课
  ```
  - 同一用户发起10次选课请求
  - 验证只有1次成功
  ```

- [ ] 测试场景3：限流测试
  ```
  - 发起超过限流阈值的请求
  - 验证限流机制生效
  ```

### 3.2 验证数据一致性
- [ ] 对比Redis库存和数据库库存
- [ ] 对比选课人数和实际选课记录数
- [ ] 验证没有超卖
- [ ] 验证没有脏数据

### 3.3 性能指标
- [ ] 响应时间 < 500ms（P95）
- [ ] 吞吐量 > 1000 TPS
- [ ] 错误率 < 0.1%
- [ ] CPU使用率 < 70%
- [ ] 内存使用率 < 80%

---

## 四、性能优化

### 4.1 SQL优化
- [ ] 使用EXPLAIN分析慢查询
- [ ] 添加必要索引
  ```sql
  -- 示例
  CREATE INDEX idx_user_username ON user(username);
  CREATE INDEX idx_enrollment_student_course ON enrollment(student_id, course_id);
  ```

- [ ] 优化N+1查询问题
- [ ] 使用批量操作
- [ ] 避免SELECT *

### 4.2 缓存优化
- [ ] 热点数据缓存
  ```java
  @Cacheable(value = "course", key = "#id")
  public CourseVO getCourseById(Long id) { ... }
  ```

- [ ] 缓存预热
- [ ] 缓存穿透防护（布隆过滤器）
- [ ] 缓存击穿防护（互斥锁）
- [ ] 缓存雪崩防护（过期时间随机化）
- [ ] 缓存更新策略（Cache Aside Pattern）

### 4.3 代码优化
- [ ] 异步处理
  ```java
  @Async
  public void sendEmail(String to, String subject, String content) { ... }
  ```

- [ ] 批量操作
  ```java
  // 批量插入
  userMapper.batchInsert(users);
  ```

- [ ] 连接池优化
  ```yaml
  spring:
    datasource:
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
  ```

- [ ] 线程池优化
  ```java
  @Bean
  public Executor taskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(10);
    executor.setMaxPoolSize(20);
    executor.setQueueCapacity(200);
    return executor;
  }
  ```

---

## 五、安全测试

### 5.1 认证授权测试
- [ ] 测试未登录访问需要认证的接口
- [ ] 测试token过期处理
- [ ] 测试token篡改检测
- [ ] 测试权限控制（RBAC）
- [ ] 测试越权访问

### 5.2 SQL注入测试
- [ ] 测试所有输入参数
- [ ] 使用预编译语句
- [ ] 参数校验

### 5.3 XSS测试
- [ ] 测试富文本输入
- [ ] 前端输出转义
- [ ] 后端内容过滤

### 5.4 CSRF测试
- [ ] 验证CSRF防护
- [ ] 使用CSRF Token

---

## 六、兼容性测试

### 6.1 浏览器兼容性
- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）

### 6.2 移动端兼容性
- [ ] iOS Safari
- [ ] Android Chrome
- [ ] 微信内置浏览器

### 6.3 分辨率测试
- [ ] 1920x1080（桌面）
- [ ] 1366x768（笔记本）
- [ ] 375x667（iPhone）
- [ ] 360x640（Android）

---

## 七、集成测试

### 7.1 端到端测试
- [ ] 用户注册 -> 登录 -> 选课 -> 学习 -> 考试 -> 获得证书
- [ ] 教师创建课程 -> 发布 -> 学员选课 -> 教师查看统计
- [ ] 管理员管理用户 -> 审核课程 -> 查看统计

### 7.2 第三方集成测试
- [ ] 支付宝支付集成测试
- [ ] Ollama AI集成测试
- [ ] 文件存储集成测试
- [ ] 邮件发送集成测试

---

## 八、监控与日志

### 8.1 添加监控
- [ ] 集成Spring Boot Actuator
  ```yaml
  management:
    endpoints:
      web:
        exposure:
          include: health,info,metrics
  ```

- [ ] 添加Prometheus监控
- [ ] 添加Grafana可视化

### 8.2 日志规范
- [ ] 统一日志格式
- [ ] 添加TraceId
- [ ] 日志分级（DEBUG, INFO, WARN, ERROR）
- [ ] 敏感信息脱敏

---

## 九、文档完善

### 9.1 API文档
- [ ] 完善Swagger文档
- [ ] 添加所有接口说明
- [ ] 添加请求/响应示例
- [ ] 添加错误码说明

### 9.2 数据库设计文档
- [ ] 编写ER图
- [ ] 编写表结构说明
- [ ] 编写字段说明
- [ ] 编写索引说明

### 9.3 部署文档
- [ ] 编写环境要求
- [ ] 编写部署步骤
- [ ] 编写配置说明
- [ ] 编写常见问题

### 9.4 用户手册
- [ ] 编写学员使用手册
- [ ] 编写教师使用手册
- [ ] 编写管理员使用手册

### 9.5 开发规范文档
- [ ] 编写代码规范
- [ ] 编写Git提交规范
- [ ] 编写接口设计规范
- [ ] 编写数据库设计规范

---

## 十、CI/CD（可选）

### 10.1 GitHub Actions配置
- [ ] 创建 `.github/workflows/ci.yml`
  ```yaml
  name: CI
  
  on:
    push:
      branches: [ main, develop ]
    pull_request:
      branches: [ main, develop ]
  
  jobs:
    build:
      runs-on: ubuntu-latest
      
      steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          
      - name: Build with Maven
        run: mvn clean install
        
      - name: Run tests
        run: mvn test
        
      - name: Code coverage
        run: mvn jacoco:report
  ```

### 10.2 自动化测试
- [ ] 配置自动运行单元测试
- [ ] 配置自动运行集成测试
- [ ] 配置代码质量检查（SonarQube）

### 10.3 自动化部署
- [ ] 配置自动构建Docker镜像
- [ ] 配置自动部署到测试环境
- [ ] 配置自动部署到生产环境

---

## 十一、上线准备

### 11.1 代码审查
- [ ] 进行全面代码审查
- [ ] 修复所有警告
- [ ] 移除调试代码
- [ ] 移除无用代码

### 11.2 配置检查
- [ ] 检查生产环境配置
- [ ] 检查数据库连接
- [ ] 检查Redis连接
- [ ] 检查第三方服务配置

### 11.3 数据备份
- [ ] 备份数据库
- [ ] 备份配置文件
- [ ] 备份文件资源

### 11.4 回滚方案
- [ ] 准备回滚脚本
- [ ] 准备数据库回滚脚本
- [ ] 测试回滚流程

---

## 十二、验收测试

### 12.1 功能验收
- [ ] 所有功能正常运行
- [ ] 所有接口测试通过
- [ ] 所有业务流程正常

### 12.2 性能验收
- [ ] 响应时间达标
- [ ] 并发处理能力达标
- [ ] 资源使用率正常

### 12.3 安全验收
- [ ] 认证授权正常
- [ ] 无安全漏洞
- [ ] 数据加密正常

### 12.4 用户验收
- [ ] 用户体验良好
- [ ] 界面友好
- [ ] 操作流畅

---

## 十三、Git提交

### 13.1 最终提交
- [ ] git add .
- [ ] git commit -m "chore: 完成集成测试和优化"
- [ ] git tag v1.0.0
- [ ] git push origin main --tags

---

## 验收标准

- ✅ 所有单元测试通过（覆盖率>80%）
- ✅ 所有接口测试通过
- ✅ 高并发测试通过（无超卖）
- ✅ 性能指标达标
- ✅ 安全测试通过
- ✅ 兼容性测试通过
- ✅ 文档完整
- ✅ 代码质量良好
- ✅ 准备好上线

---

## 预计耗时

- **总计：10-15天**
  - 单元测试：3天
  - 接口测试：2天
  - 高并发测试：2天
  - 性能优化：2天
  - 安全测试：1天
  - 集成测试：2天
  - 文档编写：2天
  - 上线准备：1天

---

## 项目完成

🎉 恭喜！IT技能培训智能选课系统开发完成！

### 项目总结
- 13个核心模块全部完成
- 高并发选课系统稳定运行
- AI智能推荐功能正常
- 完整的测试覆盖
- 详细的文档支持

### 后续维护
- 定期更新依赖版本
- 持续优化性能
- 收集用户反馈
- 迭代新功能
# 模块03：用户管理模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块02（安全与认证模块）已完成
- ✅ User、Role、UserRole实体类已创建
- ✅ 数据库表已创建

---

## 一、数据库准备

### 1.1 检查表结构
- [ ] 确认user表已存在
- [ ] 确认role表已存在
- [ ] 确认user_role表已存在
- [ ] 确认必要索引已创建

### 1.2 添加扩展字段（如需要）
- [ ] 创建 `src/main/resources/db/migration/V2__add_user_fields.sql`
- [ ] 添加用户扩展字段（如：部门、职位等）
- [ ] 执行迁移验证

---

## 二、DTO类创建

### 2.1 查询DTO
- [ ] 创建 `dto/request/UserQueryRequest.java`
  ```java
  - username: String (用户名模糊查询)
  - realName: String (真实姓名模糊查询)
  - phone: String (手机号)
  - email: String (邮箱)
  - roleId: Long (角色ID)
  - status: Integer (状态)
  - pageNum: Integer (页码)
  - pageSize: Integer (每页大小)
  ```

### 2.2 创建/更新DTO
- [ ] 创建 `dto/request/UserCreateRequest.java`
  ```java
  - username: String (@NotBlank)
  - password: String (@NotBlank, @Size(min=8, max=20))
  - realName: String (@NotBlank)
  - phone: String (@Pattern(regexp="手机号正则"))
  - email: String (@Email)
  - gender: Integer
  - birthDate: LocalDate
  - roleIds: List<Long> (角色ID列表)
  ```

- [ ] 创建 `dto/request/UserUpdateRequest.java`
  ```java
  - realName: String
  - phone: String
  - email: String
  - avatar: String
  - gender: Integer
  - birthDate: LocalDate
  - 不包含username和password
  ```

- [ ] 创建 `dto/request/PasswordUpdateRequest.java`
  ```java
  - oldPassword: String (@NotBlank)
  - newPassword: String (@NotBlank, @Size(min=8, max=20))
  - confirmPassword: String (@NotBlank)
  ```

### 2.3 响应VO
- [ ] 创建 `vo/UserInfoVO.java`
  ```java
  - id, username, realName, phone, email
  - avatar, gender, birthDate, status
  - roles: List<RoleVO> (角色列表)
  - createTime, updateTime
  - 不包含password
  ```

- [ ] 创建 `vo/RoleVO.java`
  ```java
  - id, roleName, roleCode, description
  ```

---

## 三、Mapper层完善

### 3.1 完善UserMapper
- [ ] 在 `mapper/UserMapper.java` 中添加方法：
  ```java
  - selectByCondition(UserQueryRequest request) - 条件查询
  - selectUserWithRoles(Long id) - 查询用户及角色
  - updateStatus(Long id, Integer status) - 更新状态
  - batchDelete(List<Long> ids) - 批量删除
  ```

- [ ] 在 `resources/mapper/UserMapper.xml` 中实现SQL：
  ```xml
  - 动态SQL查询（username、realName、phone、email、roleId、status）
  - 关联查询用户角色
  - 批量操作SQL
  ```

### 3.2 完善RoleMapper
- [ ] 添加方法：
  ```java
  - selectAll() - 查询所有角色
  - selectByUserId(Long userId) - 查询用户角色
  ```

### 3.3 完善UserRoleMapper
- [ ] 添加方法：
  ```java
  - deleteByUserId(Long userId) - 删除用户角色关联
  - insertBatch(List<UserRole> userRoles) - 批量插入
  ```

---

## 四、Service层实现

### 4.1 创建UserService接口
- [ ] 创建 `service/IUserService.java`
- [ ] 定义方法：
  ```java
  - PageResult<UserInfoVO> getUserList(UserQueryRequest request)
  - UserInfoVO getUserById(Long id)
  - Long createUser(UserCreateRequest request)
  - void updateUser(Long id, UserUpdateRequest request)
  - void deleteUser(Long id)
  - void batchDeleteUsers(List<Long> ids)
  - void updateStatus(Long id, Integer status)
  - void assignRoles(Long userId, List<Long> roleIds)
  - void resetPassword(Long userId, String newPassword)
  - String uploadAvatar(Long userId, MultipartFile file)
  - void updatePassword(Long userId, PasswordUpdateRequest request)
  - UserInfoVO getCurrentUser()
  ```

### 4.2 实现UserService
- [ ] 创建 `service/impl/UserServiceImpl.java`
- [ ] 实现getUserList方法：
  ```java
  - 使用PageHelper分页
  - 调用userMapper.selectByCondition()
  - 查询每个用户的角色列表
  - 转换为UserInfoVO
  - 返回PageResult
  ```

- [ ] 实现getUserById方法：
  ```java
  - 调用userMapper.selectUserWithRoles()
  - 转换为UserInfoVO（包含角色信息）
  - 用户不存在抛出NOT_FOUND异常
  ```

- [ ] 实现createUser方法：
  ```java
  - 检查用户名唯一性
  - 检查手机号唯一性
  - 检查邮箱唯一性
  - 密码加密（PasswordUtil.encode）
  - 创建用户（userMapper.insert）
  - 分配角色（userRoleMapper.insertBatch）
  - 返回用户ID
  ```

- [ ] 实现updateUser方法：
  ```java
  - 检查用户是否存在
  - 检查手机号/邮箱唯一性（排除自己）
  - 更新用户信息
  - 返回成功
  ```

- [ ] 实现deleteUser方法：
  ```java
  - 检查用户是否存在
  - 不能删除自己
  - 不能删除管理员（可选）
  - 软删除（更新status为-1）
  - 删除用户角色关联
  ```

- [ ] 实现updateStatus方法：
  ```java
  - 检查用户是否存在
  - 不能禁用自己
  - 更新状态
  ```

- [ ] 实现assignRoles方法：
  ```java
  - 检查用户是否存在
  - 检查角色是否存在
  - 删除旧的角色关联
  - 插入新的角色关联
  ```

- [ ] 实现resetPassword方法：
  ```java
  - 检查用户是否存在
  - 生成随机密码或使用默认密码
  - 密码加密
  - 更新密码
  - 发送通知（可选）
  ```

- [ ] 实现uploadAvatar方法：
  ```java
  - 验证文件类型（jpg、png、gif）
  - 验证文件大小（<2MB）
  - 调用FileUtil.upload()
  - 更新用户头像字段
  - 返回头像URL
  ```

- [ ] 实现updatePassword方法：
  ```java
  - 验证旧密码
  - 验证新密码和确认密码一致
  - 密码加密
  - 更新密码
  ```

- [ ] 实现getCurrentUser方法：
  ```java
  - 从SecurityContext获取当前用户ID
  - 调用getUserById()
  - 返回用户信息
  ```

### 4.3 创建RoleService
- [ ] 创建 `service/IRoleService.java`
- [ ] 定义方法：
  ```java
  - List<RoleVO> getAllRoles()
  - RoleVO getRoleById(Long id)
  - Long createRole(RoleCreateRequest request)
  - void updateRole(Long id, RoleUpdateRequest request)
  - void deleteRole(Long id)
  ```

- [ ] 创建 `service/impl/RoleServiceImpl.java`
- [ ] 实现基础CRUD方法

---

## 五、Controller层实现

### 5.1 创建管理员端Controller
- [ ] 创建 `controller/admin/AdminUserController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/admin/users")
  @RequireRole("admin")
  ```

- [ ] 实现GET /api/admin/users接口（用户列表）
  ```java
  - 接收UserQueryRequest
  - 参数校验
  - 调用userService.getUserList()
  - 返回Result<PageResult<UserInfoVO>>
  ```

- [ ] 实现GET /api/admin/users/{id}接口（用户详情）
  ```java
  - 接收id参数
  - 调用userService.getUserById()
  - 返回Result<UserInfoVO>
  ```

- [ ] 实现POST /api/admin/users接口（创建用户）
  ```java
  - 接收UserCreateRequest
  - @Valid参数校验
  - 调用userService.createUser()
  - 返回Result<Long>
  ```

- [ ] 实现PUT /api/admin/users/{id}接口（更新用户）
  ```java
  - 接收id和UserUpdateRequest
  - @Valid参数校验
  - 调用userService.updateUser()
  - 返回Result
  ```

- [ ] 实现DELETE /api/admin/users/{id}接口（删除用户）
  ```java
  - 接收id参数
  - 调用userService.deleteUser()
  - 返回Result
  ```

- [ ] 实现DELETE /api/admin/users/batch接口（批量删除）
  ```java
  - 接收ids列表
  - 调用userService.batchDeleteUsers()
  - 返回Result
  ```

- [ ] 实现PUT /api/admin/users/{id}/status接口（启用/禁用）
  ```java
  - 接收id和status参数
  - 调用userService.updateStatus()
  - 返回Result
  ```

- [ ] 实现PUT /api/admin/users/{id}/roles接口（分配角色）
  ```java
  - 接收id和roleIds列表
  - 调用userService.assignRoles()
  - 返回Result
  ```

- [ ] 实现PUT /api/admin/users/{id}/reset-password接口（重置密码）
  ```java
  - 接收id参数
  - 调用userService.resetPassword()
  - 返回Result<String> (返回新密码)
  ```

### 5.2 创建用户端Controller
- [ ] 创建 `controller/UserController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/user")
  @RequireLogin
  ```

- [ ] 实现GET /api/user/profile接口（获取个人信息）
  ```java
  - 调用userService.getCurrentUser()
  - 返回Result<UserInfoVO>
  ```

- [ ] 实现PUT /api/user/profile接口（更新个人信息）
  ```java
  - 接收UserUpdateRequest
  - @Valid参数校验
  - 获取当前用户ID
  - 调用userService.updateUser()
  - 返回Result
  ```

- [ ] 实现POST /api/user/avatar接口（上传头像）
  ```java
  - 接收MultipartFile
  - 获取当前用户ID
  - 调用userService.uploadAvatar()
  - 返回Result<String> (头像URL)
  ```

- [ ] 实现PUT /api/user/password接口（修改密码）
  ```java
  - 接收PasswordUpdateRequest
  - @Valid参数校验
  - 获取当前用户ID
  - 调用userService.updatePassword()
  - 返回Result
  ```

### 5.3 创建角色管理Controller
- [ ] 创建 `controller/admin/AdminRoleController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/admin/roles")
  @RequireRole("admin")
  ```

- [ ] 实现GET /api/admin/roles接口（角色列表）
  ```java
  - 调用roleService.getAllRoles()
  - 返回Result<List<RoleVO>>
  ```

- [ ] 实现POST /api/admin/roles接口（创建角色）
- [ ] 实现PUT /api/admin/roles/{id}接口（更新角色）
- [ ] 实现DELETE /api/admin/roles/{id}接口（删除角色）

---

## 六、测试

### 6.1 单元测试
- [ ] 测试UserMapper的条件查询
  ```java
  - 测试按用户名查询
  - 测试按角色查询
  - 测试分页查询
  ```

- [ ] 测试UserService的createUser方法
  ```java
  - 测试正常创建
  - 测试用户名重复
  - 测试手机号重复
  - 测试密码加密
  ```

- [ ] 测试UserService的updateUser方法
  ```java
  - 测试正常更新
  - 测试用户不存在
  - 测试手机号重复
  ```

- [ ] 测试UserService的assignRoles方法
  ```java
  - 测试分配单个角色
  - 测试分配多个角色
  - 测试角色不存在
  ```

### 6.2 接口测试
- [ ] 使用Postman测试管理员端接口
  ```
  - 测试用户列表（分页、搜索、筛选）
  - 测试创建用户（正常、参数错误、重复）
  - 测试更新用户
  - 测试删除用户
  - 测试批量删除
  - 测试启用/禁用
  - 测试分配角色
  - 测试重置密码
  ```

- [ ] 测试用户端接口
  ```
  - 测试获取个人信息
  - 测试更新个人信息
  - 测试上传头像
  - 测试修改密码（旧密码错误、新密码不一致）
  ```

- [ ] 测试权限控制
  ```
  - 测试未登录访问
  - 测试普通用户访问管理员接口
  - 测试@RequireRole注解
  ```

### 6.3 边界测试
- [ ] 测试大数据量分页
- [ ] 测试特殊字符输入
- [ ] 测试文件上传（大小、类型）
- [ ] 测试并发更新

---

## 七、文档更新

### 7.1 Swagger文档
- [ ] 为所有接口添加@Operation注解
  ```java
  @Operation(summary = "用户列表", description = "分页查询用户列表，支持多条件筛选")
  ```

- [ ] 添加@Parameter注解
  ```java
  @Parameter(name = "id", description = "用户ID", required = true)
  ```

- [ ] 添加@Schema注解到DTO
  ```java
  @Schema(description = "用户查询请求")
  ```

- [ ] 添加请求/响应示例

### 7.2 接口文档
- [ ] 编写用户管理接口文档
  ```markdown
  - 接口列表
  - 请求参数说明
  - 响应格式说明
  - 错误码说明
  - 使用示例
  ```

---

## 八、Git提交

### 8.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成用户管理模块"
  ```
  - 实现用户CRUD功能
  - 实现角色分配功能
  - 实现头像上传功能
  - 实现密码修改功能
  - 添加单元测试和接口测试
  ```
- [ ] git push

---

## 验收标准

- ✅ 管理员能查看用户列表（分页、搜索、筛选）
- ✅ 管理员能创建、编辑、删除用户
- ✅ 管理员能启用/禁用用户
- ✅ 管理员能为用户分配角色
- ✅ 管理员能重置用户密码
- ✅ 用户能查看和编辑个人信息
- ✅ 用户能上传头像
- ✅ 用户能修改密码
- ✅ 权限控制正常（未登录、无权限）
- ✅ 所有接口测试通过
- ✅ 单元测试覆盖率>80%
- ✅ Swagger文档完整

---

## 预计耗时

- **总计：3-4天**
  - DTO和Mapper层：0.5天
  - Service层实现：1天
  - Controller层实现：0.5天
  - 测试和调试：1天
  - 文档编写：0.5天

---

## 下一步

完成本模块后，进入 **模块04：课程管理模块**
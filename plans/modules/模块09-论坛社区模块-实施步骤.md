# 模块09：论坛社区模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块02（安全与认证模块）已完成
- ✅ 模块04（课程管理模块）已完成

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V8__create_forum_tables.sql`
- [ ] 编写forum_post表创建SQL
  ```sql
  CREATE TABLE forum_post (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT COMMENT '课程ID（可为空，表示全站帖子）',
    user_id BIGINT NOT NULL COMMENT '发帖人ID',
    title VARCHAR(200) NOT NULL COMMENT '帖子标题',
    content TEXT NOT NULL COMMENT '帖子内容',
    post_type TINYINT DEFAULT 1 COMMENT '帖子类型：1-讨论，2-问答，3-分享',
    view_count INT DEFAULT 0 COMMENT '浏览量',
    reply_count INT DEFAULT 0 COMMENT '回复数',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    is_top TINYINT DEFAULT 0 COMMENT '是否置顶',
    is_essence TINYINT DEFAULT 0 COMMENT '是否精华',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_course_id (course_id),
    KEY idx_user_id (user_id),
    KEY idx_post_type (post_type),
    KEY idx_is_top (is_top),
    KEY idx_is_essence (is_essence)
  ) COMMENT='论坛帖子表';
  ```

- [ ] 编写forum_reply表创建SQL
  ```sql
  CREATE TABLE forum_reply (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    post_id BIGINT NOT NULL COMMENT '帖子ID',
    user_id BIGINT NOT NULL COMMENT '回复人ID',
    parent_id BIGINT COMMENT '父回复ID（楼中楼）',
    reply_content TEXT NOT NULL COMMENT '回复内容',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_post_id (post_id),
    KEY idx_user_id (user_id),
    KEY idx_parent_id (parent_id)
  ) COMMENT='论坛回复表';
  ```

- [ ] 编写forum_like表创建SQL
  ```sql
  CREATE TABLE forum_like (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    target_type TINYINT NOT NULL COMMENT '目标类型：1-帖子，2-回复',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    user_id BIGINT NOT NULL COMMENT '点赞人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_target (user_id, target_type, target_id),
    KEY idx_target (target_type, target_id)
  ) COMMENT='论坛点赞表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建

---

## 二、实体类创建

### 2.1 创建论坛实体
- [ ] 创建 `entity/ForumPost.java`
- [ ] 创建 `entity/ForumReply.java`
- [ ] 创建 `entity/ForumLike.java`

---

## 三、DTO类创建

### 3.1 帖子DTO
- [ ] 创建 `dto/request/PostCreateRequest.java`
  ```java
  - courseId: Long
  - title: String (@NotBlank, @Size(max=200))
  - content: String (@NotBlank)
  - postType: Integer (@NotNull)
  ```

- [ ] 创建 `dto/request/PostUpdateRequest.java`
- [ ] 创建 `dto/request/PostQueryRequest.java`
  ```java
  - courseId: Long
  - postType: Integer
  - keyword: String
  - sortBy: String (latest, hot, essence)
  - pageNum: Integer
  - pageSize: Integer
  ```

### 3.2 回复DTO
- [ ] 创建 `dto/request/ReplyCreateRequest.java`
  ```java
  - postId: Long (@NotNull)
  - parentId: Long
  - replyContent: String (@NotBlank)
  ```

### 3.3 响应VO
- [ ] 创建 `vo/PostVO.java`
  ```java
  - 帖子信息
  - 发帖人信息: UserInfoVO
  - 是否已点赞: Boolean
  ```

- [ ] 创建 `vo/PostDetailVO.java`
  ```java
  - 继承PostVO
  - 回复列表: List<ReplyVO>
  ```

- [ ] 创建 `vo/ReplyVO.java`
  ```java
  - 回复信息
  - 回复人信息: UserInfoVO
  - 子回复列表: List<ReplyVO>
  - 是否已点赞: Boolean
  ```

---

## 四、Mapper层实现

### 4.1 创建ForumPostMapper
- [ ] 创建 `mapper/ForumPostMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(ForumPost post)
  - updateById(ForumPost post)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCondition(PostQueryRequest request)
  - incrementViewCount(Long id)
  - incrementReplyCount(Long id)
  - incrementLikeCount(Long id)
  - decrementLikeCount(Long id)
  - selectHotPosts(Integer limit)
  - selectEssencePosts(Integer limit)
  ```

- [ ] 创建 `resources/mapper/ForumPostMapper.xml`
- [ ] 编写SQL语句

### 4.2 创建ForumReplyMapper
- [ ] 创建 `mapper/ForumReplyMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(ForumReply reply)
  - updateById(ForumReply reply)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByPostId(Long postId, PageHelper)
  - selectByParentId(Long parentId)
  - incrementLikeCount(Long id)
  - decrementLikeCount(Long id)
  ```

- [ ] 创建 `resources/mapper/ForumReplyMapper.xml`

### 4.3 创建ForumLikeMapper
- [ ] 创建 `mapper/ForumLikeMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(ForumLike like)
  - deleteByUserAndTarget(Long userId, Integer targetType, Long targetId)
  - selectByUserAndTarget(Long userId, Integer targetType, Long targetId)
  - selectLikedTargets(Long userId, Integer targetType, List<Long> targetIds)
  ```

- [ ] 创建 `resources/mapper/ForumLikeMapper.xml`

---

## 五、Service层实现

### 5.1 创建ForumService接口
- [ ] 创建 `service/IForumService.java`
- [ ] 定义方法：
  ```java
  - PageResult<PostVO> getPostList(PostQueryRequest request)
  - PostDetailVO getPostDetail(Long postId)
  - Long createPost(PostCreateRequest request)
  - void updatePost(Long id, PostUpdateRequest request)
  - void deletePost(Long postId)
  - void likePost(Long postId, Long userId)
  - void unlikePost(Long postId, Long userId)
  - PageResult<ReplyVO> getReplyList(Long postId, Integer pageNum, Integer pageSize)
  - Long createReply(ReplyCreateRequest request)
  - void deleteReply(Long replyId)
  - void likeReply(Long replyId, Long userId)
  - void unlikeReply(Long replyId, Long userId)
  - void setTop(Long postId, Boolean isTop)
  - void setEssence(Long postId, Boolean isEssence)
  ```

### 5.2 实现ForumService
- [ ] 创建 `service/impl/ForumServiceImpl.java`
- [ ] 实现getPostList方法：
  ```java
  - 使用PageHelper分页
  - 根据sortBy排序（最新、最热、精华）
  - 查询每个帖子的发帖人信息
  - 检查当前用户是否已点赞
  - 转换为PostVO
  ```

- [ ] 实现getPostDetail方法：
  ```java
  - 查询帖子信息
  - 增加浏览量（Redis计数器）
  - 查询发帖人信息
  - 查询回复列表（分页）
  - 检查当前用户是否已点赞
  - 组装PostDetailVO
  ```

- [ ] 实现createPost方法：
  ```java
  - 内容审核（敏感词过滤）
  - 创建帖子
  - 返回帖子ID
  ```

- [ ] 实现likePost方法：
  ```java
  - 检查是否已点赞（Redis）
  - 如果已点赞，返回
  - 创建点赞记录
  - 增加帖子点赞数
  - 记录到Redis（防刷）
  ```

- [ ] 实现createReply方法：
  ```java
  - 内容审核
  - 创建回复
  - 增加帖子回复数
  - 如果是楼中楼，通知被回复人
  - 返回回复ID
  ```

---

## 六、敏感词过滤

### 6.1 创建敏感词过滤器
- [ ] 创建 `util/SensitiveWordFilter.java`
  ```java
  public class SensitiveWordFilter {
    private static Set<String> sensitiveWords = new HashSet<>();
    
    static {
      // 加载敏感词库
      sensitiveWords.add("敏感词1");
      sensitiveWords.add("敏感词2");
      // ...
    }
    
    public static boolean containsSensitiveWord(String content) {
      for (String word : sensitiveWords) {
        if (content.contains(word)) {
          return true;
        }
      }
      return false;
    }
    
    public static String replaceSensitiveWord(String content) {
      for (String word : sensitiveWords) {
        content = content.replace(word, "***");
      }
      return content;
    }
  }
  ```

---

## 七、Controller层实现

### 7.1 创建ForumController
- [ ] 创建 `controller/ForumController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/forum")
  ```

- [ ] 实现GET /api/forum/posts接口（帖子列表）
- [ ] 实现GET /api/forum/posts/{id}接口（帖子详情）
- [ ] 实现POST /api/forum/posts接口（发布帖子）
- [ ] 实现PUT /api/forum/posts/{id}接口（编辑帖子）
- [ ] 实现DELETE /api/forum/posts/{id}接口（删除帖子）
- [ ] 实现POST /api/forum/posts/{id}/like接口（点赞帖子）
- [ ] 实现DELETE /api/forum/posts/{id}/like接口（取消点赞）
- [ ] 实现GET /api/forum/posts/{id}/replies接口（回复列表）
- [ ] 实现POST /api/forum/replies接口（发布回复）
- [ ] 实现DELETE /api/forum/replies/{id}接口（删除回复）
- [ ] 实现POST /api/forum/replies/{id}/like接口（点赞回复）

### 7.2 创建管理员端Controller
- [ ] 创建 `controller/admin/AdminForumController.java`
- [ ] 实现PUT /api/admin/forum/posts/{id}/top接口（置顶）
- [ ] 实现PUT /api/admin/forum/posts/{id}/essence接口（设为精华）
- [ ] 实现DELETE /api/admin/forum/posts/{id}接口（删除帖子）

---

## 八、测试

### 8.1 单元测试
- [ ] 测试ForumPostMapper的CRUD方法
- [ ] 测试ForumService的点赞防刷
- [ ] 测试敏感词过滤

### 8.2 接口测试
- [ ] 测试帖子列表（分页、搜索、排序）
- [ ] 测试发布帖子
- [ ] 测试点赞功能
- [ ] 测试回复功能
- [ ] 测试楼中楼

---

## 九、文档更新

### 9.1 Swagger文档
- [ ] 为所有接口添加@Operation注解

### 9.2 接口文档
- [ ] 编写论坛社区接口文档

---

## 十、Git提交

### 10.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成论坛社区模块"
- [ ] git push

---

## 验收标准

- ✅ 用户能发布帖子
- ✅ 用户能回复帖子
- ✅ 用户能点赞帖子和回复
- ✅ 支持楼中楼回复
- ✅ 管理员能置顶和设置精华
- ✅ 敏感词过滤生效
- ✅ 点赞防刷生效
- ✅ 所有接口测试通过

---

## 预计耗时

- **总计：4-5天**
  - 数据库和实体类：0.5天
  - Mapper和Service层：1.5天
  - Controller层：0.5天
  - 敏感词过滤：0.5天
  - 测试和文档：1天

---

## 下一步

完成本模块后，进入 **模块10：支付管理模块**
# 模块07：技能评估模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块04（课程管理模块）已完成
- ✅ 模块05（选课管理模块）已完成

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V6__create_exam_tables.sql`
- [ ] 编写question表创建SQL
  ```sql
  CREATE TABLE question (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT NOT NULL COMMENT '课程ID',
    question_type TINYINT NOT NULL COMMENT '题型：1-单选，2-多选，3-判断，4-填空，5-简答',
    question_content TEXT NOT NULL COMMENT '题目内容',
    question_options JSON COMMENT '选项（JSON格式）',
    correct_answer VARCHAR(500) NOT NULL COMMENT '正确答案',
    question_analysis TEXT COMMENT '题目解析',
    difficulty_level TINYINT DEFAULT 1 COMMENT '难度：1-简单，2-中等，3-困难',
    score DECIMAL(5,2) DEFAULT 5.00 COMMENT '分值',
    tag_ids VARCHAR(200) COMMENT '标签ID列表',
    use_count INT DEFAULT 0 COMMENT '使用次数',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_course_id (course_id),
    KEY idx_question_type (question_type),
    KEY idx_difficulty_level (difficulty_level)
  ) COMMENT='题库表';
  ```

- [ ] 编写exam表创建SQL
  ```sql
  CREATE TABLE exam (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exam_name VARCHAR(200) NOT NULL COMMENT '考试名称',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    exam_type TINYINT NOT NULL COMMENT '考试类型：1-练习，2-测验，3-考试',
    total_score DECIMAL(5,2) NOT NULL COMMENT '总分',
    pass_score DECIMAL(5,2) NOT NULL COMMENT '及格分',
    duration INT NOT NULL COMMENT '考试时长(分钟)',
    start_time DATETIME COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    question_ids JSON NOT NULL COMMENT '题目ID列表（JSON格式）',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_course_id (course_id),
    KEY idx_exam_type (exam_type)
  ) COMMENT='考试表';
  ```

- [ ] 编写exam_record表创建SQL
  ```sql
  CREATE TABLE exam_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exam_id BIGINT NOT NULL COMMENT '考试ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    submit_time DATETIME COMMENT '提交时间',
    score DECIMAL(5,2) COMMENT '得分',
    is_pass TINYINT COMMENT '是否通过',
    answer_data JSON COMMENT '答题数据（JSON格式）',
    status TINYINT DEFAULT 1 COMMENT '状态：1-进行中，2-已提交，3-已评分',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_exam_id (exam_id),
    KEY idx_student_id (student_id),
    KEY idx_status (status)
  ) COMMENT='考试记录表';
  ```

- [ ] 编写certificate表创建SQL
  ```sql
  CREATE TABLE certificate (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    certificate_no VARCHAR(50) UNIQUE NOT NULL COMMENT '证书编号',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    certificate_type TINYINT DEFAULT 1 COMMENT '证书类型：1-结业证书，2-优秀证书',
    certificate_name VARCHAR(200) NOT NULL COMMENT '证书名称',
    certificate_url VARCHAR(500) COMMENT '证书URL',
    issue_date DATE NOT NULL COMMENT '颁发日期',
    expiry_date DATE COMMENT '过期日期',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_student_id (student_id),
    KEY idx_course_id (course_id),
    KEY idx_certificate_no (certificate_no)
  ) COMMENT='证书表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建

---

## 二、实体类创建

### 2.1 创建Question实体
- [ ] 创建 `entity/Question.java`
- [ ] 定义所有字段
- [ ] 添加注解

### 2.2 创建Exam实体
- [ ] 创建 `entity/Exam.java`
- [ ] 定义所有字段
- [ ] 添加注解

### 2.3 创建ExamRecord实体
- [ ] 创建 `entity/ExamRecord.java`
- [ ] 定义所有字段
- [ ] 添加注解

### 2.4 创建Certificate实体
- [ ] 创建 `entity/Certificate.java`
- [ ] 定义所有字段
- [ ] 添加注解

---

## 三、DTO类创建

### 3.1 题库DTO
- [ ] 创建 `dto/request/QuestionCreateRequest.java`
  ```java
  - courseId: Long (@NotNull)
  - questionType: Integer (@NotNull)
  - questionContent: String (@NotBlank)
  - questionOptions: List<String> (选项列表)
  - correctAnswer: String (@NotBlank)
  - questionAnalysis: String
  - difficultyLevel: Integer
  - score: BigDecimal
  - tagIds: List<Long>
  ```

- [ ] 创建 `dto/request/QuestionUpdateRequest.java`
- [ ] 创建 `dto/request/QuestionQueryRequest.java`
- [ ] 创建 `dto/request/QuestionImportRequest.java` (批量导入)

### 3.2 考试DTO
- [ ] 创建 `dto/request/ExamCreateRequest.java`
  ```java
  - examName: String (@NotBlank)
  - courseId: Long (@NotNull)
  - examType: Integer (@NotNull)
  - totalScore: BigDecimal (@NotNull)
  - passScore: BigDecimal (@NotNull)
  - duration: Integer (@NotNull)
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - questionIds: List<Long> (题目ID列表)
  ```

- [ ] 创建 `dto/request/ExamUpdateRequest.java`
- [ ] 创建 `dto/request/ExamAnswerRequest.java`
  ```java
  - examId: Long (@NotNull)
  - answers: Map<Long, String> (题目ID -> 答案)
  ```

### 3.3 响应VO
- [ ] 创建 `vo/QuestionVO.java`
- [ ] 创建 `vo/ExamVO.java`
- [ ] 创建 `vo/ExamPaperVO.java` (试卷，包含题目列表)
- [ ] 创建 `vo/ExamRecordVO.java`
- [ ] 创建 `vo/CertificateVO.java`

---

## 四、Mapper层实现

### 4.1 创建QuestionMapper
- [ ] 创建 `mapper/QuestionMapper.java` 接口
- [ ] 定义方法：
  ```java
  - insert(Question question)
  - updateById(Question question)
  - deleteById(Long id)
  - selectById(Long id)
  - selectByCondition(QuestionQueryRequest request)
  - selectRandomQuestions(Long courseId, Integer count, Integer difficultyLevel)
  - incrementUseCount(Long id)
  - batchInsert(List<Question> questions)
  ```

- [ ] 创建 `resources/mapper/QuestionMapper.xml`
- [ ] 编写SQL语句

### 4.2 创建ExamMapper
- [ ] 创建 `mapper/ExamMapper.java` 接口
- [ ] 创建 `resources/mapper/ExamMapper.xml`

### 4.3 创建ExamRecordMapper
- [ ] 创建 `mapper/ExamRecordMapper.java` 接口
- [ ] 创建 `resources/mapper/ExamRecordMapper.xml`

### 4.4 创建CertificateMapper
- [ ] 创建 `mapper/CertificateMapper.java` 接口
- [ ] 创建 `resources/mapper/CertificateMapper.xml`

---

## 五、Service层实现

### 5.1 创建QuestionService
- [ ] 创建 `service/IQuestionService.java`
- [ ] 定义方法：
  ```java
  - PageResult<QuestionVO> getQuestionList(QuestionQueryRequest request)
  - QuestionVO getQuestionById(Long id)
  - Long createQuestion(QuestionCreateRequest request)
  - void updateQuestion(Long id, QuestionUpdateRequest request)
  - void deleteQuestion(Long id)
  - void batchImport(MultipartFile file) - Excel导入
  - List<QuestionVO> getRandomQuestions(Long courseId, Integer count, Integer difficultyLevel)
  ```

- [ ] 创建 `service/impl/QuestionServiceImpl.java`
- [ ] 实现batchImport方法：
  ```java
  - 使用EasyExcel读取Excel
  - 验证数据格式
  - 批量插入题目
  - 返回导入结果
  ```

### 5.2 创建ExamService
- [ ] 创建 `service/IExamService.java`
- [ ] 定义方法：
  ```java
  - Long createExam(ExamCreateRequest request)
  - void updateExam(Long id, ExamUpdateRequest request)
  - void deleteExam(Long id)
  - ExamVO getExamById(Long id)
  - List<ExamVO> getExamsByCourseId(Long courseId)
  - ExamPaperVO generatePaper(Long examId) - 生成试卷
  - Long startExam(Long examId, Long studentId) - 开始考试
  - void submitExam(ExamAnswerRequest request) - 提交答卷
  - ExamRecordVO getExamRecord(Long recordId)
  - PageResult<ExamRecordVO> getMyExamRecords(Long studentId, Integer pageNum, Integer pageSize)
  ```

- [ ] 创建 `service/impl/ExamServiceImpl.java`
- [ ] 实现generatePaper方法：
  ```java
  - 查询考试信息
  - 根据questionIds查询题目
  - 题目乱序（防作弊）
  - 选项乱序（防作弊）
  - 组装试卷VO
  - 不返回正确答案
  ```

- [ ] 实现startExam方法：
  ```java
  - 检查考试时间
  - 检查是否已参加
  - 创建考试记录
  - 设置考试状态为进行中
  - 在Redis中记录考试开始时间
  - 返回考试记录ID
  ```

- [ ] 实现submitExam方法：
  ```java
  - 查询考试记录
  - 检查考试状态
  - 检查考试时间是否超时
  - 保存答题数据
  - 自动评分（选择题、判断题）
  - 计算总分
  - 判断是否通过
  - 更新考试记录
  - 如果通过且完成课程，生成证书
  ```

- [ ] 实现自动评分逻辑：
  ```java
  private BigDecimal autoGrade(ExamAnswerRequest request, Exam exam) {
    BigDecimal totalScore = BigDecimal.ZERO;
    
    // 查询所有题目
    List<Question> questions = questionMapper.selectByIds(exam.getQuestionIds());
    
    for (Question question : questions) {
      String studentAnswer = request.getAnswers().get(question.getId());
      String correctAnswer = question.getCorrectAnswer();
      
      // 根据题型判分
      if (question.getQuestionType() == 1 || question.getQuestionType() == 3) {
        // 单选题、判断题：完全匹配
        if (correctAnswer.equals(studentAnswer)) {
          totalScore = totalScore.add(question.getScore());
        }
      } else if (question.getQuestionType() == 2) {
        // 多选题：完全匹配
        if (correctAnswer.equals(studentAnswer)) {
          totalScore = totalScore.add(question.getScore());
        }
      }
      // 填空题和简答题需要人工评分
    }
    
    return totalScore;
  }
  ```

### 5.3 创建CertificateService
- [ ] 创建 `service/ICertificateService.java`
- [ ] 定义方法：
  ```java
  - String generateCertificate(Long studentId, Long courseId) - 生成证书
  - PageResult<CertificateVO> getMyCertificates(Long studentId, Integer pageNum, Integer pageSize)
  - CertificateVO getCertificateById(Long id)
  - byte[] downloadCertificate(Long id) - 下载证书PDF
  - CertificateVO verifyCertificate(String certificateNo) - 验证证书
  ```

- [ ] 创建 `service/impl/CertificateServiceImpl.java`
- [ ] 实现generateCertificate方法：
  ```java
  - 检查是否已生成证书
  - 生成唯一证书编号
  - 使用PDF模板生成证书
  - 上传到文件服务器
  - 保存证书记录
  - 返回证书URL
  ```

---

## 六、Controller层实现

### 6.1 创建教师端题库Controller
- [ ] 创建 `controller/teacher/TeacherQuestionController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/teacher/questions")
  @RequireRole("teacher")
  ```

- [ ] 实现GET /api/teacher/questions接口（题库列表）
- [ ] 实现POST /api/teacher/questions接口（创建试题）
- [ ] 实现PUT /api/teacher/questions/{id}接口（更新试题）
- [ ] 实现DELETE /api/teacher/questions/{id}接口（删除试题）
- [ ] 实现POST /api/teacher/questions/batch接口（批量导入）

### 6.2 创建教师端考试Controller
- [ ] 创建 `controller/teacher/TeacherExamController.java`
- [ ] 实现POST /api/teacher/exams接口（创建考试）
- [ ] 实现PUT /api/teacher/exams/{id}接口（更新考试）
- [ ] 实现DELETE /api/teacher/exams/{id}接口（删除考试）
- [ ] 实现POST /api/teacher/exams/{id}/generate接口（生成试卷）
- [ ] 实现GET /api/teacher/exams/{id}/records接口（考试记录列表）

### 6.3 创建学生端考试Controller
- [ ] 创建 `controller/ExamController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/exams")
  @RequireLogin
  ```

- [ ] 实现GET /api/exams/course/{courseId}接口（课程考试列表）
- [ ] 实现GET /api/exams/{id}接口（考试详情）
- [ ] 实现POST /api/exams/{id}/start接口（开始考试）
- [ ] 实现POST /api/exams/{id}/submit接口（提交答卷）
- [ ] 实现GET /api/exams/records/{recordId}接口（考试记录详情）
- [ ] 实现GET /api/exams/records/my接口（我的考试记录）

### 6.4 创建证书Controller
- [ ] 创建 `controller/CertificateController.java`
- [ ] 实现GET /api/certificates/my接口（我的证书列表）
- [ ] 实现GET /api/certificates/{id}接口（证书详情）
- [ ] 实现GET /api/certificates/{id}/download接口（下载证书）
- [ ] 实现GET /api/certificates/verify/{certificateNo}接口（验证证书）

---

## 七、考试计时器

### 7.1 创建考试计时器
- [ ] 使用Redis存储考试状态
  ```java
  - key: exam:timer:recordId
  - value: 剩余时间（秒）
  - 过期时间: 考试时长
  ```

- [ ] 前端轮询获取剩余时间
- [ ] 时间到自动提交

---

## 八、防作弊机制

### 8.1 实现防作弊措施
- [ ] 题目乱序
- [ ] 选项乱序
- [ ] 限制考试时间
- [ ] 记录考试过程（切屏次数等）
- [ ] 禁止复制粘贴（前端控制）

---

## 九、测试

### 9.1 单元测试
- [ ] 测试QuestionMapper的CRUD方法
- [ ] 测试ExamService的试卷生成
- [ ] 测试ExamService的自动评分
- [ ] 测试CertificateService的证书生成

### 9.2 接口测试
- [ ] 测试题库管理
- [ ] 测试考试管理
- [ ] 测试开始考试
- [ ] 测试提交答卷
- [ ] 测试自动评分
- [ ] 测试证书生成

---

## 十、文档更新

### 10.1 Swagger文档
- [ ] 为所有接口添加@Operation注解
- [ ] 添加请求/响应示例

### 10.2 接口文档
- [ ] 编写技能评估接口文档
- [ ] 说明评分规则
- [ ] 说明防作弊机制

---

## 十一、Git提交

### 11.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成技能评估模块"
- [ ] git push

---

## 验收标准

- ✅ 教师能创建和管理题库
- ✅ 教师能创建和管理考试
- ✅ 教师能批量导入题目
- ✅ 学员能参加考试
- ✅ 学员能提交答卷
- ✅ 系统能自动评分
- ✅ 系统能生成证书
- ✅ 防作弊机制生效
- ✅ 所有接口测试通过
- ✅ 单元测试覆盖率>80%

---

## 预计耗时

- **总计：5-7天**
  - 数据库和实体类：1天
  - Mapper和Service层：2.5天
  - Controller层：1天
  - 测试和文档：1.5天

---

## 下一步

完成本模块后，进入 **模块08：AI智能推荐模块**
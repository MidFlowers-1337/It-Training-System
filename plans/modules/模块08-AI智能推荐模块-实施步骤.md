# 模块08：AI智能推荐模块 - 实施步骤

## 前置条件

- ✅ 模块01（基础工程与公共模块）已完成
- ✅ 模块04（课程管理模块）已完成
- ✅ 模块05（选课管理模块）已完成
- ✅ Ollama服务已部署
- ✅ Spring AI依赖已配置

---

## 一、数据库准备

### 1.1 创建Flyway迁移脚本
- [ ] 创建 `src/main/resources/db/migration/V7__create_ai_tables.sql`
- [ ] 编写student_skill表创建SQL
  ```sql
  CREATE TABLE student_skill (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    skill_name VARCHAR(100) NOT NULL COMMENT '技能名称',
    skill_level TINYINT DEFAULT 1 COMMENT '技能等级：1-初级，2-中级，3-高级',
    skill_score INT DEFAULT 0 COMMENT '技能分数',
    acquire_time DATETIME COMMENT '获得时间',
    last_practice_time DATETIME COMMENT '最后练习时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_student_id (student_id),
    KEY idx_skill_name (skill_name)
  ) COMMENT='学员技能表';
  ```

- [ ] 编写learning_path表创建SQL
  ```sql
  CREATE TABLE learning_path (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    path_name VARCHAR(200) NOT NULL COMMENT '路径名称',
    path_type TINYINT NOT NULL COMMENT '路径类型：1-前端，2-后端，3-全栈，4-AI',
    target_position VARCHAR(100) COMMENT '目标职位',
    difficulty_level TINYINT DEFAULT 1 COMMENT '难度等级',
    description TEXT COMMENT '路径描述',
    course_sequence JSON NOT NULL COMMENT '课程序列（JSON格式）',
    estimated_duration INT COMMENT '预计时长(天)',
    status TINYINT DEFAULT 1 COMMENT '状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_path_type (path_type)
  ) COMMENT='学习路径表';
  ```

- [ ] 编写ai_recommendation表创建SQL
  ```sql
  CREATE TABLE ai_recommendation (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    course_id BIGINT NOT NULL COMMENT '课程ID',
    recommendation_type TINYINT NOT NULL COMMENT '推荐类型：1-基于内容，2-协同过滤，3-AI推荐',
    recommendation_score DECIMAL(5,2) COMMENT '推荐分数',
    recommendation_reason TEXT COMMENT '推荐理由',
    is_accepted TINYINT COMMENT '是否接受：0-未操作，1-接受，2-拒绝',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_student_id (student_id),
    KEY idx_course_id (course_id)
  ) COMMENT='AI推荐记录表';
  ```

- [ ] 编写ai_conversation表创建SQL
  ```sql
  CREATE TABLE ai_conversation (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    session_id VARCHAR(50) NOT NULL COMMENT '会话ID',
    user_message TEXT NOT NULL COMMENT '用户消息',
    ai_response TEXT NOT NULL COMMENT 'AI回复',
    message_type TINYINT DEFAULT 1 COMMENT '消息类型：1-普通对话，2-课程推荐，3-学习建议',
    context_data JSON COMMENT '上下文数据',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_session_id (session_id)
  ) COMMENT='AI对话记录表';
  ```

### 1.2 执行数据库迁移
- [ ] 启动应用，Flyway自动执行迁移
- [ ] 验证表已创建

---

## 二、实体类创建

### 2.1 创建AI相关实体
- [ ] 创建 `entity/StudentSkill.java`
- [ ] 创建 `entity/LearningPath.java`
- [ ] 创建 `entity/AiRecommendation.java`
- [ ] 创建 `entity/AiConversation.java`

---

## 三、DTO类创建

### 3.1 AI对话DTO
- [ ] 创建 `dto/request/AiChatRequest.java`
  ```java
  - message: String (@NotBlank)
  - sessionId: String
  ```

- [ ] 创建 `dto/response/AiChatResponse.java`
  ```java
  - response: String
  - sessionId: String
  - recommendations: List<CourseVO> (可选的课程推荐)
  ```

### 3.2 推荐DTO
- [ ] 创建 `dto/request/RecommendationFeedbackRequest.java`
  ```java
  - recommendationId: Long (@NotNull)
  - isAccepted: Boolean (@NotNull)
  ```

### 3.3 响应VO
- [ ] 创建 `vo/RecommendationVO.java`
- [ ] 创建 `vo/LearningPathVO.java`
- [ ] 创建 `vo/SkillTreeVO.java`

---

## 四、Ollama配置

### 4.1 创建Ollama配置类
- [ ] 创建 `config/OllamaConfig.java`
  ```java
  @Configuration
  public class OllamaConfig {
    @Value("${spring.ai.ollama.base-url}")
    private String baseUrl;
    
    @Value("${spring.ai.ollama.model}")
    private String model;
    
    @Bean
    public OllamaChatClient ollamaChatClient() {
      return new OllamaChatClient(baseUrl, model);
    }
  }
  ```

### 4.2 配置application.yaml
- [ ] 添加Ollama配置
  ```yaml
  spring:
    ai:
      ollama:
        base-url: http://localhost:11434
        model: qwen2.5:latest
        timeout: 60s
  ```

---

## 五、Prompt模板管理

### 5.1 创建Prompt模板类
- [ ] 创建 `ai/PromptTemplate.java`
  ```java
  public class PromptTemplate {
    // 课程推荐模板
    public static final String COURSE_RECOMMEND_PROMPT = """
      你是一位专业的IT培训顾问。根据以下学员信息，推荐合适的课程：
      
      学员背景：
      - 已学课程：{completedCourses}
      - 技能水平：{skills}
      - 学习目标：{goal}
      
      可选课程列表：
      {availableCourses}
      
      请推荐3-5门最适合的课程，并说明推荐理由。
      """;
    
    // 学习路径模板
    public static final String LEARNING_PATH_PROMPT = """
      你是一位IT职业规划专家。根据以下信息，制定学习路径：
      
      目标职位：{targetPosition}
      当前技能：{currentSkills}
      学习时间：{availableTime}
      
      可选课程：
      {courses}
      
      请制定一个循序渐进的学习路径，包括课程顺序和学习建议。
      """;
    
    // 技能评估模板
    public static final String SKILL_ASSESSMENT_PROMPT = """
      根据学员的学习记录，评估其技能水平：
      
      已完成课程：{completedCourses}
      考试成绩：{examScores}
      学习时长：{studyDuration}
      
      请评估学员在以下技能的掌握程度：{skills}
      并给出提升建议。
      """;
    
    public static String buildPrompt(String template, Map<String, String> params) {
      String result = template;
      for (Map.Entry<String, String> entry : params.entrySet()) {
        result = result.replace("{" + entry.getKey() + "}", entry.getValue());
      }
      return result;
    }
  }
  ```

---

## 六、Service层实现

### 6.1 创建AiChatService
- [ ] 创建 `service/IAiChatService.java`
- [ ] 定义方法：
  ```java
  - AiChatResponse chat(Long userId, String message, String sessionId)
  - List<AiConversation> getConversationHistory(String sessionId)
  - void clearConversation(String sessionId)
  ```

- [ ] 创建 `service/impl/AiChatServiceImpl.java`
- [ ] 实现chat方法：
  ```java
  @Override
  public AiChatResponse chat(Long userId, String message, String sessionId) {
    // 1. 生成或使用现有sessionId
    if (sessionId == null) {
      sessionId = UUID.randomUUID().toString();
    }
    
    // 2. 获取对话历史（从Redis）
    List<AiConversation> history = getConversationHistory(sessionId);
    
    // 3. 构建上下文
    StringBuilder context = new StringBuilder();
    for (AiConversation conv : history) {
      context.append("用户：").append(conv.getUserMessage()).append("\n");
      context.append("AI：").append(conv.getAiResponse()).append("\n");
    }
    context.append("用户：").append(message);
    
    // 4. 调用Ollama API
    String prompt = context.toString();
    String aiResponse = ollamaChatClient.call(prompt);
    
    // 5. 保存对话记录
    AiConversation conversation = new AiConversation();
    conversation.setUserId(userId);
    conversation.setSessionId(sessionId);
    conversation.setUserMessage(message);
    conversation.setAiResponse(aiResponse);
    conversation.setMessageType(1);
    aiConversationMapper.insert(conversation);
    
    // 6. 更新Redis缓存
    updateConversationCache(sessionId, conversation);
    
    // 7. 返回响应
    AiChatResponse response = new AiChatResponse();
    response.setResponse(aiResponse);
    response.setSessionId(sessionId);
    
    return response;
  }
  ```

### 6.2 创建AiRecommendService
- [ ] 创建 `service/IAiRecommendService.java`
- [ ] 定义方法：
  ```java
  - List<RecommendationVO> recommendCourses(Long studentId)
  - List<RecommendationVO> recommendByContent(Long studentId)
  - List<RecommendationVO> recommendByCollaborative(Long studentId)
  - LearningPathVO recommendLearningPath(Long studentId, String targetPosition)
  - void saveFeedback(Long recommendationId, Boolean isAccepted)
  ```

- [ ] 创建 `service/impl/AiRecommendServiceImpl.java`
- [ ] 实现recommendCourses方法（AI推荐）：
  ```java
  @Override
  public List<RecommendationVO> recommendCourses(Long studentId) {
    // 1. 获取学员信息
    User student = userMapper.selectById(studentId);
    
    // 2. 获取已完成课程
    List<Enrollment> completedEnrollments = enrollmentMapper.selectCompletedByStudentId(studentId);
    String completedCourses = completedEnrollments.stream()
      .map(e -> courseMapper.selectById(e.getCourseId()).getCourseName())
      .collect(Collectors.joining(", "));
    
    // 3. 获取技能水平
    List<StudentSkill> skills = studentSkillMapper.selectByStudentId(studentId);
    String skillsStr = skills.stream()
      .map(s -> s.getSkillName() + "(" + s.getSkillLevel() + ")")
      .collect(Collectors.joining(", "));
    
    // 4. 获取可选课程
    List<Course> availableCourses = courseMapper.selectAvailableCourses(studentId);
    String coursesStr = availableCourses.stream()
      .map(c -> c.getCourseName() + " - " + c.getDescription())
      .collect(Collectors.joining("\n"));
    
    // 5. 构建Prompt
    Map<String, String> params = new HashMap<>();
    params.put("completedCourses", completedCourses);
    params.put("skills", skillsStr);
    params.put("goal", "提升技能，找到更好的工作");
    params.put("availableCourses", coursesStr);
    
    String prompt = PromptTemplate.buildPrompt(
      PromptTemplate.COURSE_RECOMMEND_PROMPT, 
      params
    );
    
    // 6. 调用AI
    String aiResponse = ollamaChatClient.call(prompt);
    
    // 7. 解析AI响应，提取推荐课程
    List<RecommendationVO> recommendations = parseRecommendations(
      aiResponse, 
      availableCourses, 
      studentId
    );
    
    // 8. 保存推荐记录
    for (RecommendationVO rec : recommendations) {
      AiRecommendation record = new AiRecommendation();
      record.setStudentId(studentId);
      record.setCourseId(rec.getCourseId());
      record.setRecommendationType(3); // AI推荐
      record.setRecommendationScore(rec.getScore());
      record.setRecommendationReason(rec.getReason());
      aiRecommendationMapper.insert(record);
    }
    
    return recommendations;
  }
  ```

- [ ] 实现recommendByContent方法（基于内容推荐）：
  ```java
  @Override
  public List<RecommendationVO> recommendByContent(Long studentId) {
    // 1. 获取学员已学课程的标签
    List<Long> learnedTags = getLearnedTags(studentId);
    
    // 2. 查找具有相似标签的课程
    List<Course> similarCourses = courseMapper.selectBySimilarTags(
      learnedTags, 
      studentId
    );
    
    // 3. 计算相似度得分
    List<RecommendationVO> recommendations = new ArrayList<>();
    for (Course course : similarCourses) {
      double score = calculateSimilarityScore(learnedTags, course);
      
      RecommendationVO vo = new RecommendationVO();
      vo.setCourseId(course.getId());
      vo.setCourseName(course.getCourseName());
      vo.setScore(BigDecimal.valueOf(score));
      vo.setReason("基于您已学课程的内容相似度推荐");
      
      recommendations.add(vo);
    }
    
    // 4. 按分数排序
    recommendations.sort((a, b) -> b.getScore().compareTo(a.getScore()));
    
    return recommendations.subList(0, Math.min(5, recommendations.size()));
  }
  ```

- [ ] 实现recommendByCollaborative方法（协同过滤）：
  ```java
  @Override
  public List<RecommendationVO> recommendByCollaborative(Long studentId) {
    // 1. 找到相似学员（选过相同课程的学员）
    List<Long> similarStudents = findSimilarStudents(studentId);
    
    // 2. 获取相似学员选过但当前学员未选的课程
    List<Course> recommendedCourses = courseMapper.selectByOtherStudents(
      similarStudents, 
      studentId
    );
    
    // 3. 计算推荐分数
    List<RecommendationVO> recommendations = new ArrayList<>();
    for (Course course : recommendedCourses) {
      int count = countStudentsEnrolled(similarStudents, course.getId());
      double score = (double) count / similarStudents.size() * 100;
      
      RecommendationVO vo = new RecommendationVO();
      vo.setCourseId(course.getId());
      vo.setCourseName(course.getCourseName());
      vo.setScore(BigDecimal.valueOf(score));
      vo.setReason("与您学习路径相似的学员也选择了这门课程");
      
      recommendations.add(vo);
    }
    
    recommendations.sort((a, b) -> b.getScore().compareTo(a.getScore()));
    
    return recommendations.subList(0, Math.min(5, recommendations.size()));
  }
  ```

---

## 七、Controller层实现

### 7.1 创建AiController
- [ ] 创建 `controller/AiController.java`
- [ ] 添加注解：
  ```java
  @RestController
  @RequestMapping("/api/ai")
  @RequireLogin
  ```

- [ ] 实现POST /api/ai/chat接口（AI对话）
- [ ] 实现GET /api/ai/recommend接口（获取推荐课程）
- [ ] 实现POST /api/ai/recommend/feedback接口（推荐反馈）
- [ ] 实现GET /api/ai/learning-path接口（获取学习路径）
- [ ] 实现GET /api/ai/conversations接口（对话历史）

---

## 八、测试

### 8.1 单元测试
- [ ] 测试Prompt模板构建
- [ ] 测试AI对话功能
- [ ] 测试推荐算法

### 8.2 接口测试
- [ ] 测试AI对话接口
- [ ] 测试课程推荐接口
- [ ] 测试学习路径推荐

---

## 九、文档更新

### 9.1 Swagger文档
- [ ] 为所有接口添加@Operation注解

### 9.2 技术文档
- [ ] 编写AI推荐方案文档
- [ ] 说明推荐算法原理

---

## 十、Git提交

### 10.1 提交代码
- [ ] git add .
- [ ] git commit -m "feat: 完成AI智能推荐模块"
- [ ] git push

---

## 验收标准

- ✅ AI对话功能正常
- ✅ 课程推荐功能正常
- ✅ 学习路径推荐功能正常
- ✅ 推荐反馈功能正常
- ✅ 所有接口测试通过

---

## 预计耗时

- **总计：7-10天**
  - 数据库和实体类：1天
  - Ollama集成：2天
  - 推荐算法实现：3天
  - AI对话实现：2天
  - 测试和文档：2天

---

## 下一步

完成本模块后，进入 **模块09：论坛社区模块**